<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FUTURA 2026 | Cloud Sync</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Icone -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 25%),
                radial-gradient(circle at 85% 30%, rgba(168, 85, 247, 0.15) 0%, transparent 25%);
            background-attachment: fixed;
        }

        /* Glassmorphism */
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: white;
            transition: all 0.3s;
        }
        .glass-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .animate-enter {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeIn {
            to { opacity: 1; transform: translateY(0); }
        }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="min-h-screen flex flex-col p-4 md:p-6 max-w-6xl mx-auto">

    <!-- 1. SETUP SCREEN (Solo la prima volta) -->
    <div v-if="needsSetup" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f172a] animate-enter">
        <div class="glass-card max-w-md w-full p-8 rounded-2xl">
            <div class="text-center mb-6">
                <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-4"></i>
                <h1 class="text-2xl font-bold text-white">Connessione Cloud</h1>
                <p class="text-slate-400 text-sm mt-2">Inserisci i dati di JSONBin.io per abilitare la sincronizzazione remota.</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="text-xs text-slate-500 uppercase font-bold">Bin ID</label>
                    <input type="text" v-model="setup.binId" placeholder="es. 673b..." class="glass-input w-full rounded-lg p-3 mt-1 text-sm">
                </div>
                <div>
                    <label class="text-xs text-slate-500 uppercase font-bold">X-Master-Key (API Key)</label>
                    <input type="password" v-model="setup.apiKey" placeholder="es. $2a$10$..." class="glass-input w-full rounded-lg p-3 mt-1 text-sm">
                </div>
                <button @click="saveSetup" class="w-full btn-primary text-white font-bold py-3 rounded-xl mt-4 transition hover:opacity-90">
                    COLLEGA DATABASE
                </button>
            </div>
        </div>
    </div>

    <!-- 2. LOGIN SCREEN -->
    <div v-else-if="!authenticated" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f172a] animate-enter">
        <div class="text-center max-w-sm w-full p-6">
            <div class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-indigo-500 to-purple-500 shadow-lg shadow-indigo-500/30">
                <i class="fas fa-fingerprint text-3xl text-white"></i>
            </div>
            <h1 class="text-4xl font-bold mb-2 text-white tracking-tight">FUTURA <span class="text-indigo-400">SYNC</span></h1>
            
            <div class="relative mt-8">
                <input type="password" v-model="inputPin" @keyup.enter="checkPin" placeholder="PIN (0000)" 
                    class="glass-input w-full text-center text-xl rounded-xl p-4 placeholder-slate-600 focus:border-indigo-500">
            </div>
            
            <button @click="checkPin" class="w-full mt-4 btn-primary text-white font-bold py-4 rounded-xl transition transform active:scale-95">
                <span v-if="!loading">SBLOCCA & SINCRONIZZA</span>
                <div v-else class="flex justify-center"><div class="loader"></div></div>
            </button>
            
            <p v-if="error" class="text-red-400 mt-4 text-sm font-semibold animate-pulse">{{ errorMsg }}</p>
        </div>
    </div>

    <!-- 3. MAIN DASHBOARD -->
    <div v-else class="animate-enter pb-20">
        
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white">Dashboard Finanziaria</h1>
                <div class="flex items-center gap-2 text-slate-400 text-xs font-mono mt-1">
                    <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span>
                    CLOUD SYNC ACTIVE • Ultimo sync: {{ lastSavedTime }}
                </div>
            </div>
            <div class="flex gap-3">
                <button @click="syncData(true)" class="px-4 py-2 rounded-lg bg-indigo-600/20 hover:bg-indigo-600 border border-indigo-500/30 hover:border-indigo-500 transition text-indigo-100 hover:text-white text-sm font-medium flex items-center gap-2">
                    <i class="fas fa-cloud-upload-alt" ref="syncIcon"></i>
                    <span v-if="!isSyncing">Salva su Cloud</span>
                    <span v-else>Salvataggio...</span>
                </button>
                <button @click="logout" class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition text-slate-300 text-sm">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </header>

        <!-- KPI CARDS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6 mb-8">
            <!-- Saldo Attuale -->
            <div class="glass-card rounded-2xl p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500 rounded-full filter blur-[60px] opacity-20"></div>
                <h3 class="text-slate-400 font-medium text-xs uppercase tracking-widest mb-2">Disponibilità Liquida</h3>
                <span class="text-4xl font-bold text-white tracking-tight">€ {{ formatNumber(currentBalance) }}</span>
            </div>

            <!-- Residuo Papà -->
            <div class="glass-card rounded-2xl p-6 relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500 rounded-full filter blur-[60px] opacity-20"></div>
                <h3 class="text-slate-400 font-medium text-xs uppercase tracking-widest mb-2">Credito vs Papà</h3>
                <div class="flex items-end gap-2">
                    <span class="text-4xl font-bold text-white tracking-tight">€ {{ formatNumber(remainingLoan) }}</span>
                    <span class="mb-1.5 text-sm text-slate-500">/ {{ formatNumber(totalLoanOriginal) }}</span>
                </div>
                <div class="mt-4 h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                    <div class="h-full bg-gradient-to-r from-purple-500 to-fuchsia-500" :style="{ width: loanProgress + '%' }"></div>
                </div>
            </div>

            <!-- Forecast -->
            <div class="glass-card rounded-2xl p-6 relative overflow-hidden border-indigo-500/30">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500 rounded-full filter blur-[60px] opacity-30"></div>
                <h3 class="text-indigo-300 font-medium text-xs uppercase tracking-widest mb-2">Previsione Feb 2026</h3>
                <span class="text-4xl font-bold text-indigo-50 tracking-tight">€ {{ formatNumber(forecastBalance) }}</span>
            </div>
        </div>

        <!-- MAIN GRID -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- LEFT: Manual Entries -->
            <div class="lg:col-span-4 space-y-6">
                <div class="glass-card rounded-2xl p-5">
                    <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fas fa-plus-circle text-indigo-400"></i> Movimento Manuale
                    </h2>
                    <div class="space-y-3">
                        <div class="grid grid-cols-2 gap-2 p-1 bg-slate-900/50 rounded-xl">
                            <button @click="newTrans.type = 'in'" class="py-2 rounded-lg text-sm font-bold transition-all" :class="newTrans.type === 'in' ? 'bg-green-600 text-white shadow-lg' : 'text-slate-400'">Entrata</button>
                            <button @click="newTrans.type = 'out'" class="py-2 rounded-lg text-sm font-bold transition-all" :class="newTrans.type === 'out' ? 'bg-red-600 text-white shadow-lg' : 'text-slate-400'">Uscita</button>
                        </div>
                        <input type="text" v-model="newTrans.desc" placeholder="Descrizione" class="glass-input w-full rounded-xl p-3 text-sm">
                        <input type="number" v-model="newTrans.amount" placeholder="0.00" step="0.01" class="glass-input w-full rounded-xl p-3 text-sm font-mono" @keyup.enter="addTransaction">
                        <button @click="addTransaction" class="w-full btn-primary text-white font-bold py-3 rounded-xl text-sm shadow-lg hover:opacity-90" :disabled="!newTrans.desc || !newTrans.amount">AGGIUNGI</button>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-5 h-[400px] flex flex-col">
                    <h2 class="text-lg font-bold text-white mb-4"><i class="fas fa-history text-slate-400 mr-2"></i>Storico</h2>
                    <div class="flex-1 overflow-y-auto pr-2 space-y-2 custom-scrollbar">
                        <div v-if="manualTransactions.length === 0" class="text-center text-slate-500 text-sm py-10 italic">Nessun movimento.</div>
                        <div v-for="(t, index) in manualTransactions" :key="index" class="group flex items-center justify-between p-3 rounded-xl bg-slate-800/40 border border-slate-700/50 hover:bg-slate-800 transition">
                            <div>
                                <div class="text-sm font-medium text-slate-200">{{ t.desc }}</div>
                                <div class="text-[10px] text-slate-500">{{ t.date }}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-mono font-bold text-sm" :class="t.type === 'in' ? 'text-green-400' : 'text-red-400'">{{ t.type === 'in' ? '+' : '-' }}{{ formatNumber(t.amount) }}</span>
                                <button @click="removeTransaction(index)" class="text-slate-600 hover:text-red-400 transition opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Checklists & PDF Data -->
            <div class="lg:col-span-8 space-y-6">
                <div class="glass-card rounded-2xl p-6">
                    <h2 class="text-lg font-bold text-white mb-4"><i class="fas fa-check-double text-green-400 mr-2"></i>In Arrivo (Da PDF)</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div v-for="(income, index) in futureIncomes" :key="index" 
                             class="relative overflow-hidden p-3 rounded-xl border transition-all cursor-pointer select-none"
                             :class="income.received ? 'bg-green-500/10 border-green-500/30' : 'bg-slate-800/40 border-slate-700/50 hover:border-indigo-500/50'"
                             @click="toggleIncome(index)">
                            <div class="flex items-center justify-between relative z-10">
                                <div class="flex items-center gap-3">
                                    <div class="w-5 h-5 rounded border flex items-center justify-center transition-colors" :class="income.received ? 'bg-green-500 border-green-500' : 'border-slate-500'"><i v-if="income.received" class="fas fa-check text-white text-[10px]"></i></div>
                                    <span class="text-sm font-medium" :class="income.received ? 'text-green-200/70 line-through' : 'text-slate-200'">{{ income.desc }}</span>
                                </div>
                                <span class="font-mono font-bold text-sm" :class="income.received ? 'text-green-400/70' : 'text-white'">€ {{ formatNumber(income.amount) }}</span>
                            </div>
                            <div class="absolute inset-0 bg-green-500/5 transition-transform duration-500 origin-left" :style="{ transform: income.received ? 'scaleX(1)' : 'scaleX(0)' }"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-card rounded-2xl p-5">
                     <h2 class="text-lg font-bold text-white mb-4"><i class="fas fa-file-invoice-dollar text-red-400 mr-2"></i>Uscite Future Fisse</h2>
                     <div class="space-y-2">
                        <div class="flex justify-between bg-red-500/10 p-3 rounded-lg border border-red-500/20">
                            <span class="text-red-200 text-sm">Rate PC + Spese Varie</span>
                            <span class="font-mono font-bold text-red-400">- € 526</span>
                        </div>
                     </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                // Stati dell'applicazione
                needsSetup: false,
                authenticated: false,
                loading: false,
                isSyncing: false,
                error: false,
                errorMsg: '',
                inputPin: '',
                
                // Configurazione Cloud (Salvata in localStorage)
                setup: {
                    binId: '',
                    apiKey: ''
                },

                lastSavedTime: '...',

                // DATA MODEL
                currentBalance: 110,
                manualTransactions: [],
                loans: [ /* Dati statici */ ], // Mantenuti per calcoli ma non salvati se non cambiano
                futureIncomes: [
                    { desc: "Restituzione residuo papà", amount: 800, received: false },
                    { desc: "Due rate EduNet19 (10%+10%)", amount: 560, received: false },
                    { desc: "Conguaglio EduNet19 (30%)", amount: 840, received: false },
                    { desc: "Residuo Progetto Franco", amount: 200, received: false },
                    { desc: "Borsa di Studio Unimi", amount: 1936, received: false }
                ],
                newTrans: { desc: '', amount: null, type: 'out' }
            }
        },
        computed: {
            totalLoanOriginal() { return 1680; },
            totalRepaid() { return 880; },
            remainingLoan() { return this.totalLoanOriginal - this.totalRepaid; },
            loanProgress() { return Math.round((this.totalRepaid / this.totalLoanOriginal) * 100); },
            forecastBalance() {
                let pendingIncome = this.futureIncomes.filter(i => !i.received).reduce((acc, i) => acc + i.amount, 0);
                let fixedExpenses = 526; 
                return this.currentBalance + pendingIncome - fixedExpenses;
            }
        },
        mounted() {
            // 1. Controlla se abbiamo le credenziali cloud
            const cloudConfig = localStorage.getItem('futura_cloud_config');
            if (!cloudConfig) {
                this.needsSetup = true;
            } else {
                this.setup = JSON.parse(cloudConfig);
            }
        },
        methods: {
            saveSetup() {
                if(this.setup.binId && this.setup.apiKey) {
                    localStorage.setItem('futura_cloud_config', JSON.stringify(this.setup));
                    this.needsSetup = false;
                    alert("Configurazione salvata! Ora puoi accedere.");
                }
            },

            async checkPin() {
                if (this.inputPin === '0000') {
                    this.loading = true;
                    this.error = false;
                    try {
                        // Tenta di scaricare i dati dal cloud
                        await this.loadDataFromCloud();
                        this.authenticated = true;
                    } catch (e) {
                        this.error = true;
                        this.errorMsg = "Errore Cloud: " + e.message;
                        // Se è la prima volta e il bin è vuoto, permetti accesso per inizializzare
                        if(e.message.includes("Empty") || confirm("Impossibile scaricare dati. Accedere offline?")) {
                             this.authenticated = true;
                        }
                    } finally {
                        this.loading = false;
                    }
                } else {
                    this.error = true;
                    this.errorMsg = "PIN Errato";
                    this.inputPin = '';
                }
            },

            async loadDataFromCloud() {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${this.setup.binId}`, {
                    method: 'GET',
                    headers: { 'X-Master-Key': this.setup.apiKey }
                });
                
                if (!response.ok) throw new Error("Bin ID o Key errati");
                
                const data = await response.json();
                const record = data.record;

                // Se il record è vuoto (nuovo bin), non fare nulla
                if (Object.keys(record).length === 0) return;

                // Applica i dati
                this.currentBalance = record.currentBalance ?? 110;
                this.futureIncomes = record.futureIncomes ?? this.futureIncomes;
                this.manualTransactions = record.manualTransactions ?? [];
                this.lastSavedTime = record.lastSavedTime ?? 'Mai';
            },

            async syncData(manual = false) {
                this.isSyncing = true;
                const now = new Date().toLocaleTimeString('it-IT', {hour: '2-digit', minute:'2-digit'});
                this.lastSavedTime = now;

                const payload = {
                    currentBalance: this.currentBalance,
                    futureIncomes: this.futureIncomes,
                    manualTransactions: this.manualTransactions,
                    lastSavedTime: now
                };

                try {
                    await fetch(`https://api.jsonbin.io/v3/b/${this.setup.binId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': this.setup.apiKey
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    // Feedback visivo
                    if(manual) {
                        const icon = this.$refs.syncIcon;
                        icon.className = "fas fa-check text-green-400";
                        setTimeout(() => icon.className = "fas fa-cloud-upload-alt", 1500);
                    }

                } catch (e) {
                    alert("Errore salvataggio cloud: " + e.message);
                } finally {
                    this.isSyncing = false;
                }
            },

            formatNumber(val) {
                return val.toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            },

            toggleIncome(index) {
                const item = this.futureIncomes[index];
                item.received = !item.received;
                if (item.received) this.currentBalance += item.amount;
                else this.currentBalance -= item.amount;
                this.syncData(); // Auto-sync
            },

            addTransaction() {
                if(!this.newTrans.desc || !this.newTrans.amount) return;
                const amount = parseFloat(this.newTrans.amount);
                if(this.newTrans.type === 'in') this.currentBalance += amount;
                else this.currentBalance -= amount;

                this.manualTransactions.unshift({
                    desc: this.newTrans.desc,
                    amount: amount,
                    type: this.newTrans.type,
                    date: new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short' })
                });

                this.newTrans.desc = ''; this.newTrans.amount = null;
                this.syncData(); // Auto-sync
            },

            removeTransaction(index) {
                const t = this.manualTransactions[index];
                if(t.type === 'in') this.currentBalance -= t.amount;
                else this.currentBalance += t.amount;
                this.manualTransactions.splice(index, 1);
                this.syncData(); // Auto-sync
            },

            logout() {
                this.authenticated = false;
                this.inputPin = '';
            }
        }
    }).mount('#app');
</script>
</body>
</html>