<!DOCTYPE html>
<html lang="it">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SEO & META TAGS -->
    <title>Gestione Finanze Personali - Futura Cloud Sync</title>
    <meta name="description"
        content="Piattaforma avanzata per la gestione finanze personali. Monitora spese, entrate, prestiti e debiti con Futura Cloud Sync. Ottimizza il tuo budget e il risparmio.">
    <meta name="keywords"
        content="gestione finanze personali, budget, spese, entrate, prestiti, risparmio, dashboard finanziaria">

    <!-- PWA META TAGS -->
    <meta name="theme-color" content="#6366f1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FUTURA SYNC">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <!-- NUOVI MODULI JS -->
    <script src="js/utils.js"></script>
    <script src="js/db.js"></script>
    <script src="js/sync-manager.js"></script>
    <script src="js/categories.js"></script>
    <script src="js/analytics.js"></script>
    <script src="js/budget.js"></script>
    <script src="js/recurring.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/health-score.js"></script>
    <script src="js/insights.js"></script>
    <script src="js/savings-goals.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            background-attachment: fixed;
            background-image: radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 25%), radial-gradient(circle at 85% 30%, rgba(168, 85, 247, 0.15) 0%, transparent 25%);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: white;
            transition: all 0.3s;
        }

        .glass-input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid #6366f1;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .animate-enter {
            animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>

    <div id="app" v-cloak class="min-h-screen flex flex-col p-4 md:p-6 max-w-6xl mx-auto">

        <!-- 1. SETUP SCREEN -->
        <div v-if="needsSetup" class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f172a] animate-enter">
            <div class="glass-card max-w-md w-full p-8 rounded-2xl">
                <div class="text-center mb-6">
                    <i class="fas fa-cloud-upload-alt text-4xl text-indigo-400 mb-4"></i>
                    <h1 class="text-2xl font-bold text-white">Connessione Cloud</h1>
                    <p class="text-slate-400 text-sm mt-2">Inserisci i dati di JSONBin.io</p>
                </div>
                <form @submit.prevent="saveSetup" class="space-y-4">
                    <div>
                        <label class="text-xs text-slate-500 uppercase font-bold">Bin ID</label>
                        <input type="text" v-model="setup.binId" placeholder="es. 673b..."
                            class="glass-input w-full rounded-lg p-3 mt-1 text-sm" autocomplete="username">
                    </div>
                    <div>
                        <label class="text-xs text-slate-500 uppercase font-bold">X-Master-Key</label>
                        <input type="password" v-model="setup.apiKey" placeholder="es. $2a$..."
                            class="glass-input w-full rounded-lg p-3 mt-1 text-sm" autocomplete="current-password">
                    </div>
                    <button type="submit"
                        class="w-full btn-primary text-white font-bold py-3 rounded-xl mt-4 transition hover:opacity-90">
                        <span v-if="!loading">COLLEGA E PROVA</span>
                        <div v-else class="flex justify-center">
                            <div class="loader"></div>
                        </div>
                    </button>
                    <p v-if="error" class="text-red-400 text-xs text-center mt-2 font-bold bg-red-900/20 p-2 rounded">{{
                        errorMsg }}</p>
                </form>
            </div>
        </div>

        <!-- 2. LOGIN SCREEN -->
        <div v-else-if="!authenticated"
            class="fixed inset-0 z-50 flex items-center justify-center bg-[#0f172a] animate-enter">
            <div class="text-center max-w-sm w-full p-6">
                <div
                    class="mb-6 inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-indigo-500 to-purple-500 shadow-lg shadow-indigo-500/30">
                    <i class="fas fa-fingerprint text-3xl text-white"></i>
                </div>
                <h1 class="text-4xl font-bold mb-2 text-white tracking-tight">FUTURA <span
                        class="text-indigo-400">SYNC</span></h1>

                <form @submit.prevent="checkPin" class="relative mt-8">
                    <input type="password" v-model="inputPin" placeholder="PIN (0000)"
                        class="glass-input w-full text-center text-xl rounded-xl p-4 placeholder-slate-600 focus:border-indigo-500" autocomplete="current-password">

                    <button type="submit"
                        class="w-full mt-4 btn-primary text-white font-bold py-4 rounded-xl transition transform active:scale-95">
                        <span v-if="!loading">SBLOCCA</span>
                        <div v-else class="flex justify-center">
                            <div class="loader"></div>
                        </div>
                    </button>
                </form>

                <div class="mt-4 text-center">
                    <p v-if="error" class="text-red-400 text-sm font-semibold mb-2 bg-red-900/20 p-2 rounded">{{
                        errorMsg }}</p>
                    <button @click="resetConfig" class="text-xs text-slate-500 underline hover:text-slate-300">Reset
                        Configurazione Cloud</button>
                </div>
            </div>
        </div>

        <!-- 3. DASHBOARD -->
        <div v-else class="animate-enter pb-20">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">Gestione Finanze Personali</h1>
                    <div class="flex items-center gap-2 text-slate-400 text-xs font-mono mt-1">
                        <span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span>
                        ONLINE • Sync: {{ lastSavedTime }}
                    </div>
                </div>
                <div class="flex gap-3">
                    <button @click="syncData(true)"
                        class="px-4 py-2 rounded-lg bg-indigo-600/20 hover:bg-indigo-600 border border-indigo-500/30 transition text-indigo-100 hover:text-white text-sm font-medium flex items-center gap-2">
                        <i class="fas fa-cloud-upload-alt" ref="syncIcon"></i> <span v-if="!isSyncing">Salva
                            Cloud</span><span v-else>...</span>
                    </button>
                    <button @click="logout"
                        class="px-4 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 border border-slate-700 transition text-slate-300 text-sm"><i
                            class="fas fa-sign-out-alt"></i></button>
                </div>
            </header>

            <!-- NEW: HEALTH SCORE & INSIGHTS SUMMARY -->
            <div v-if="healthScore" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Health Score Card -->
                <div class="glass-card rounded-2xl p-6 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <div class="flex items-center gap-2">
                                <h3 class="text-slate-400 font-medium text-xs uppercase tracking-widest">Salute
                                    Finanziaria</h3>
                                <button @click="showHealthInfo = true"
                                    class="text-slate-500 hover:text-indigo-400 transition">
                                    <i class="fas fa-info-circle text-xs"></i>
                                </button>
                            </div>
                            <div class="flex items-baseline gap-2 mt-1">
                                <span class="text-4xl font-bold" :style="{ color: healthScore.grade.color }">{{
                                    healthScore.totalScore }}/100</span>
                                <span class="text-lg font-bold px-2 py-0.5 rounded bg-slate-800"
                                    :style="{ color: healthScore.grade.color }">{{ healthScore.grade.label }}</span>
                            </div>
                        </div>
                        <div class="w-12 h-12 rounded-full flex items-center justify-center bg-slate-800 text-2xl">
                            {{ healthScore.grade.letter }}
                        </div>
                    </div>

                    <div class="space-y-3 mt-4">
                        <div v-for="(metric, key) in healthScore.metrics" :key="key"
                            class="flex items-center justify-between text-xs">
                            <span class="text-slate-400 capitalize">{{ key.replace(/([A-Z])/g, ' $1').trim() }}</span>
                            <div class="flex items-center gap-2 w-1/2">
                                <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-500"
                                        :class="getMetricColor(metric.status)"
                                        :style="{ width: (metric.score / (key === 'savingRate' ? 30 : key === 'debtRatio' ? 25 : key === 'budgetAdherence' ? 20 : key === 'emergencyFund' ? 15 : 10)) * 100 + '%' }">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Insights Card -->
                <div class="glass-card rounded-2xl p-6 relative overflow-hidden">
                    <h3 class="text-slate-400 font-medium text-xs uppercase tracking-widest mb-4">Insights & Avvisi</h3>
                    <div v-if="insights.length === 0" class="text-center text-slate-500 text-sm py-4">Nessun insight
                        rilevante al momento</div>
                    <div class="space-y-3 max-h-[180px] overflow-y-auto pr-2">
                        <div v-for="(insight, idx) in insights.slice(0, 3)" :key="idx"
                            class="flex gap-3 p-3 rounded-xl bg-slate-800/40 border border-slate-700/50">
                            <div class="text-xl">{{ insight.icon }}</div>
                            <div>
                                <div class="text-sm font-bold text-white">{{ insight.title }}</div>
                                <div class="text-xs text-slate-400 leading-relaxed">{{ insight.message }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SAVINGS GOALS SECTION -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-white"><i class="fas fa-bullseye text-pink-400 mr-2"></i>Obiettivi
                        di Risparmio</h2>
                    <button @click="showAddGoalModal = true"
                        class="text-xs bg-pink-500/20 text-pink-300 px-3 py-1.5 rounded-lg hover:bg-pink-500/30 transition">+
                        Nuovo</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div v-for="goal in savingsGoals" :key="goal.id"
                        class="glass-card p-5 rounded-2xl relative overflow-hidden">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-white">{{ goal.name }}</h3>
                            <span class="text-xs font-mono text-slate-400" v-if="goal.targetDate">{{ new
                                Date(goal.targetDate).toLocaleDateString() }}</span>
                        </div>
                        <button @click="editGoal(goal)" class="absolute top-4 right-4 text-slate-600 hover:text-white transition">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <div class="flex items-end gap-2 mb-3">
                            <span class="text-2xl font-bold text-pink-400">€ {{ formatNumber(goal.currentAmount)
                                }}</span>
                            <span class="text-xs text-slate-500 mb-1.5">/ € {{ formatNumber(goal.targetAmount) }}</span>
                        </div>
                        <div class="h-2 w-full bg-slate-800 rounded-full overflow-hidden mb-3">
                            <div class="h-full bg-gradient-to-r from-pink-500 to-rose-500"
                                :style="{ width: Math.min((goal.currentAmount / goal.targetAmount) * 100, 100) + '%' }">
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-slate-500">{{ Math.round((goal.currentAmount / goal.targetAmount)
                                * 100) }}% completato</span>
                            <button @click="addGoalContribution(goal)"
                                class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-2 py-1 rounded transition">Versa</button>
                        </div>
                    </div>

                    <div v-if="savingsGoals.length === 0"
                        class="col-span-full text-center py-8 glass-card rounded-2xl border-dashed border-slate-700">
                        <p class="text-slate-500 text-sm">Nessun obiettivo di risparmio attivo</p>
                    </div>
                </div>
            </div>

            <!-- SPESE RATEIZZATE -->
            <div class="mb-8" v-if="installments.length > 0 || true">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-bold text-white"><i class="fas fa-calendar-alt text-orange-400 mr-2"></i>Spese Rateizzate</h2>
                    <button @click="showAddInstallmentModal = true"
                        class="text-xs bg-orange-500/20 text-orange-300 px-3 py-1.5 rounded-lg hover:bg-orange-500/30 transition">+ Nuova Rata</button>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div v-for="inst in installments" :key="inst.id" class="glass-card p-4 rounded-2xl relative group">
                        <button @click="editInstallment(inst)" class="absolute top-3 right-3 text-slate-600 hover:text-white transition opacity-0 group-hover:opacity-100">
                            <i class="fas fa-pen text-xs"></i>
                        </button>
                        <h3 class="font-bold text-white mb-1">{{ inst.name }}</h3>
                        <div class="text-xs text-slate-400 mb-2">{{ inst.paidRates }}/{{ inst.numRates }} rate pagate</div>
                        <div class="flex items-end gap-2 mb-2">
                            <span class="text-xl font-bold text-orange-400">€ {{ formatNumber(inst.rateAmount) }}</span>
                            <span class="text-xs text-slate-500 mb-0.5">/rata</span>
                        </div>
                        <div class="h-1.5 w-full bg-slate-800 rounded-full overflow-hidden mb-2">
                            <div class="h-full bg-gradient-to-r from-orange-500 to-amber-500"
                                :style="{ width: (inst.paidRates / inst.numRates) * 100 + '%' }"></div>
                        </div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-slate-500">Giorno {{ inst.dayOfMonth }} del mese</span>
                            <button @click="payInstallmentRate(inst)" v-if="inst.paidRates < inst.numRates"
                                class="bg-orange-600/20 hover:bg-orange-600 text-orange-200 px-2 py-1 rounded transition">Paga Rata</button>
                            <span v-else class="text-green-400">✓ Completato</span>
                        </div>
                    </div>
                    <div v-if="installments.length === 0" class="col-span-full text-center py-6 glass-card rounded-2xl border-dashed border-slate-700">
                        <p class="text-slate-500 text-sm">Nessuna spesa rateizzata attiva</p>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <!-- DISPONIBILITÀ - MODIFICABILE -->
                <div class="glass-card rounded-2xl p-6 relative overflow-hidden group cursor-pointer" @click="showBalanceEditModal = true">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-slate-400 font-medium text-xs uppercase tracking-widest">Disponibilità</h3>
                        <i class="fas fa-edit text-slate-600 group-hover:text-indigo-400 transition text-xs"></i>
                    </div>
                    <span class="text-4xl font-bold text-white">€ {{ formatNumber(currentBalance) }}</span>
                    <div class="text-xs text-slate-500 mt-2">Click per modificare</div>
                </div>
                
                <!-- CREDITO PAPÀ - MODIFICABILE -->
                <div class="glass-card rounded-2xl p-6 relative overflow-hidden group cursor-pointer" @click="editPapaLoan">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-slate-400 font-medium text-xs uppercase tracking-widest">Credito Papà</h3>
                        <i class="fas fa-edit text-slate-600 group-hover:text-purple-400 transition text-xs"></i>
                    </div>
                    <div class="flex items-end gap-2">
                        <span class="text-4xl font-bold text-white">€ {{ formatNumber(remainingLoan) }}</span>
                        <span class="mb-1.5 text-sm text-slate-500">/ {{ formatNumber(totalLoanOriginal) }}</span>
                    </div>
                    <div class="mt-4 h-1.5 w-full bg-slate-800 rounded-full">
                        <div class="h-full bg-gradient-to-r from-purple-500 to-fuchsia-500"
                            :style="{ width: loanProgress + '%' }"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-2">Click per modificare</div>
                </div>
                
                <!-- PREVISIONE -->
                <div class="glass-card rounded-2xl p-6 relative overflow-hidden border-indigo-500/30">
                    <h3 class="text-indigo-300 font-medium text-xs uppercase tracking-widest mb-2">Prev. Feb 2026</h3>
                    <span class="text-4xl font-bold text-indigo-50">€ {{ formatNumber(forecastBalance) }}</span>
                    <div class="text-xs text-slate-500 mt-2">
                        <span v-if="forecastBalance > currentBalance" class="text-green-400">+{{ formatNumber(forecastBalance - currentBalance) }} previsti</span>
                        <span v-else class="text-red-400">{{ formatNumber(forecastBalance - currentBalance) }} previsti</span>
                    </div>
                </div>
            </div>

            <!-- QUICK STATS & TOOLS -->
            <div class="glass-card rounded-2xl p-4 mb-8">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex flex-wrap gap-4">
                        <div class="text-center px-4 py-2 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-500">Spese Mese</div>
                            <div class="text-lg font-bold text-red-400">-€ {{ formatNumber(monthlyExpenses) }}</div>
                        </div>
                        <div class="text-center px-4 py-2 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-500">Entrate Mese</div>
                            <div class="text-lg font-bold text-green-400">+€ {{ formatNumber(monthlyIncome) }}</div>
                        </div>
                        <div class="text-center px-4 py-2 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-500">Bilancio Mese</div>
                            <div class="text-lg font-bold" :class="monthlyBalance >= 0 ? 'text-green-400' : 'text-red-400'">
                                {{ monthlyBalance >= 0 ? '+' : '' }}€ {{ formatNumber(monthlyBalance) }}
                            </div>
                        </div>
                        <div class="text-center px-4 py-2 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-500">Transazioni</div>
                            <div class="text-lg font-bold text-slate-300">{{ manualTransactions.length }}</div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button @click="exportData" class="text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg transition" title="Esporta Backup">
                            <i class="fas fa-download mr-1"></i> Backup
                        </button>
                        <button @click="resetAllData" class="text-xs bg-red-900/30 hover:bg-red-900/50 text-red-300 px-3 py-2 rounded-lg transition" title="Reset Dati">
                            <i class="fas fa-trash mr-1"></i> Reset
                        </button>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6"></div>
                <div class="lg:col-span-4 space-y-6">
                    <div class="glass-card rounded-2xl p-5">
                        <h2 class="text-lg font-bold text-white mb-4"><i
                                class="fas fa-plus-circle text-indigo-400 mr-2"></i>Manuale</h2>
                        <form @submit.prevent="addTransaction" class="space-y-3">
                            <div class="grid grid-cols-2 gap-2 p-1 bg-slate-900/50 rounded-xl">
                                <button type="button" @click="newTrans.type = 'in'"
                                    class="py-2 rounded-lg text-sm font-bold transition-all"
                                    :class="newTrans.type === 'in' ? 'bg-green-600 text-white' : 'text-slate-400'">Entrata</button>
                                <button type="button" @click="newTrans.type = 'out'"
                                    class="py-2 rounded-lg text-sm font-bold transition-all"
                                    :class="newTrans.type === 'out' ? 'bg-red-600 text-white' : 'text-slate-400'">Uscita</button>
                            </div>
                            <input type="text" v-model="newTrans.desc" placeholder="Descrizione"
                                class="glass-input w-full rounded-xl p-3 text-sm">
                            <input type="number" v-model="newTrans.amount" placeholder="0.00" step="0.01"
                                class="glass-input w-full rounded-xl p-3 text-sm font-mono">
                            <button type="submit"
                                class="w-full btn-primary text-white font-bold py-3 rounded-xl text-sm"
                                :disabled="!newTrans.desc || !newTrans.amount">AGGIUNGI</button>
                        </form>
                    </div>
                    <div class="glass-card rounded-2xl p-5 h-[400px] flex flex-col">
                        <h2 class="text-lg font-bold text-white mb-4"><i
                                class="fas fa-history text-slate-400 mr-2"></i>Storico</h2>
                        <div class="flex-1 overflow-y-auto pr-2 space-y-2">
                            <div v-if="manualTransactions.length === 0"
                                class="text-center text-slate-500 text-sm py-10 italic">Vuoto</div>
                            <div v-for="(t, index) in manualTransactions" :key="index"
                                class="flex items-center justify-between p-3 rounded-xl bg-slate-800/40 border border-slate-700/50">
                                <div>
                                    <div class="text-sm font-medium text-slate-200">{{ t.desc }}</div>
                                    <div class="text-[10px] text-slate-500">{{ t.date }}</div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-mono font-bold text-sm"
                                        :class="t.type === 'in' ? 'text-green-400' : 'text-red-400'">{{ t.type === 'in'
                                        ? '+' : '-' }}{{ formatNumber(t.amount) }}</span>
                                    <div class="flex gap-2">
                                        <button @click="editTransaction(index)" class="text-slate-600 hover:text-blue-400"><i class="fas fa-pen"></i></button>
                                        <button @click="removeTransaction(index)" class="text-slate-600 hover:text-red-400"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-white"><i class="fas fa-check-double text-green-400 mr-2"></i>In Arrivo (Da PDF)</h2>
                            <button @click="addFutureIncome" class="text-xs bg-green-500/20 text-green-300 px-3 py-1.5 rounded-lg hover:bg-green-500/30 transition">+ Aggiungi</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div v-for="(income, index) in futureIncomes" :key="index"
                                class="relative overflow-hidden p-3 rounded-xl border transition-all select-none group"
                                :class="income.received ? 'bg-green-500/10 border-green-500/30' : 'bg-slate-800/40 border-slate-700/50'">
                                <div class="flex items-center justify-between relative z-10" @click="toggleIncome(index)">
                                    <div class="flex items-center gap-3 cursor-pointer">
                                        <div class="w-5 h-5 rounded border flex items-center justify-center"
                                            :class="income.received ? 'bg-green-500 border-green-500' : 'border-slate-500'">
                                            <i v-if="income.received" class="fas fa-check text-white text-[10px]"></i>
                                        </div>
                                        <span class="text-sm font-medium"
                                            :class="income.received ? 'text-green-200/70 line-through' : 'text-slate-200'">{{
                                            income.desc }}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-mono font-bold text-sm"
                                            :class="income.received ? 'text-green-400/70' : 'text-white'">€ {{
                                            formatNumber(income.amount) }}</span>
                                        <button @click.stop="editFutureIncome(index)" class="opacity-0 group-hover:opacity-100 transition text-slate-500 hover:text-blue-400 ml-2 p-1">
                                            <i class="fas fa-pen text-xs"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold text-white"><i
                                    class="fas fa-hand-holding-usd text-yellow-400 mr-2"></i>Crediti & Prestiti</h2>
                            <span class="text-xs font-mono bg-yellow-500/20 text-yellow-200 px-2 py-1 rounded">Tot.
                                Attivi: € {{ formatNumber(totalActiveCredits) }}</span>
                        </div>

                        <div class="bg-slate-800/40 rounded-xl p-4 mb-6 border border-dashed border-slate-700">
                            <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Registra Prestito (Uscita)</h4>
                            <form @submit.prevent="addLoan" class="grid grid-cols-1 md:grid-cols-12 gap-2">
                                <div class="md:col-span-3">
                                    <input type="text" v-model="newLoan.debtor" placeholder="Chi (Debitore)?"
                                        class="glass-input w-full rounded-lg p-2 text-sm">
                                </div>
                                <div class="md:col-span-5">
                                    <input type="text" v-model="newLoan.desc" placeholder="Descrizione prestito"
                                        class="glass-input w-full rounded-lg p-2 text-sm">
                                </div>
                                <div class="md:col-span-2">
                                    <input type="number" v-model="newLoan.amount" placeholder="€" step="0.01"
                                        class="glass-input w-full rounded-lg p-2 text-sm font-mono">
                                </div>
                                <div class="md:col-span-2">
                                    <button type="submit"
                                        class="w-full h-full bg-yellow-600/80 hover:bg-yellow-600 text-white text-xs font-bold rounded-lg transition"
                                        :disabled="!newLoan.debtor || !newLoan.amount">PRESTA</button>
                                </div>
                            </form>
                        </div>

                        <div class="space-y-3">
                            <div v-if="activeLoans.length === 0" class="text-center text-slate-500 text-sm py-4 italic">
                                Nessun credito attivo</div>
                            <div v-for="loan in activeLoans" :key="loan.id"
                                class="relative overflow-hidden p-4 rounded-xl bg-slate-800/40 border border-slate-700/50">
                                <div
                                    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div>
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-white">{{ loan.debtor }}</span>
                                            <span class="text-xs text-slate-500">{{ loan.date }}</span>
                                            <span v-if="loan.repaidAmount >= loan.originalAmount"
                                                class="text-[10px] bg-green-500/20 text-green-300 px-1.5 py-0.5 rounded">COMPLETATO</span>
                                        </div>
                                        <div class="text-sm text-slate-300">{{ loan.desc }}</div>
                                        <div class="mt-1 text-xs text-slate-400">Rimborsati: <span
                                                class="text-green-400 font-mono">€ {{ formatNumber(loan.repaidAmount)
                                                }}</span> su <span class="text-white font-mono">€ {{
                                                formatNumber(loan.originalAmount) }}</span></div>
                                        <div class="mt-2 h-1 w-32 bg-slate-700 rounded-full overflow-hidden">
                                            <div class="h-full bg-green-500"
                                                :style="{ width: Math.min((loan.repaidAmount / loan.originalAmount) * 100, 100) + '%' }">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="flex items-center gap-2 w-full md:w-auto mt-2 md:mt-0">
                                        <div v-if="loan.repaidAmount < loan.originalAmount" class="flex gap-2">
                                            <input type="number" v-model="repayInput[loan.id]" placeholder="Rimborsa..."
                                                class="glass-input w-24 text-xs p-2 rounded-lg font-mono">
                                            <button @click="repayLoan(loan.id)"
                                                class="bg-green-600/20 hover:bg-green-600 border border-green-600/50 text-green-100 text-xs font-bold py-2 px-3 rounded-lg transition">
                                                <i class="fas fa-download mr-1"></i> INCASSA
                                            </button>
                                        </div>
                                        <button @click="editLoan(loan)" class="ml-2 text-slate-600 hover:text-blue-400 p-2"><i class="fas fa-pen"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card rounded-2xl p-5">
                        <div class="flex justify-between bg-red-500/10 p-3 rounded-lg border border-red-500/20">
                            <span class="text-red-200 text-sm">Uscite Future Fisse (PC + Varie)</span>
                            <span class="font-mono font-bold text-red-400">- € 526</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SEZIONE GRAFICI -->
            <div class="mt-8 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-white">
                        <i class="fas fa-chart-area text-indigo-400 mr-2"></i>Analisi Finanziaria
                    </h2>
                    <div class="flex gap-2">
                        <button @click="chartPeriod = '7d'" 
                            :class="chartPeriod === '7d' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400'"
                            class="px-3 py-1.5 rounded-lg text-xs font-bold transition">7G</button>
                        <button @click="chartPeriod = '30d'" 
                            :class="chartPeriod === '30d' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400'"
                            class="px-3 py-1.5 rounded-lg text-xs font-bold transition">30G</button>
                        <button @click="chartPeriod = 'all'" 
                            :class="chartPeriod === 'all' ? 'bg-indigo-600 text-white' : 'bg-slate-800 text-slate-400'"
                            class="px-3 py-1.5 rounded-lg text-xs font-bold transition">Tutto</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Grafico Entrate vs Uscite -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="text-sm font-bold text-slate-300 mb-4">
                            <i class="fas fa-exchange-alt text-emerald-400 mr-2"></i>Entrate vs Uscite
                        </h3>
                        <div class="h-64">
                            <canvas ref="chartIncomeExpense"></canvas>
                        </div>
                        <div class="flex justify-center gap-6 mt-4 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-emerald-500"></div>
                                <span class="text-slate-400">Entrate: <span class="text-emerald-400 font-bold">€ {{ formatNumber(chartData.totalIncome) }}</span></span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-3 h-3 rounded-full bg-rose-500"></div>
                                <span class="text-slate-400">Uscite: <span class="text-rose-400 font-bold">€ {{ formatNumber(chartData.totalExpense) }}</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Grafico Distribuzione Spese per Categoria -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="text-sm font-bold text-slate-300 mb-4">
                            <i class="fas fa-pie-chart text-purple-400 mr-2"></i>Distribuzione Spese
                        </h3>
                        <div class="h-64 flex items-center justify-center">
                            <canvas ref="chartCategories"></canvas>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-4">
                            <div v-for="(cat, idx) in chartData.topCategories" :key="idx" class="flex items-center gap-2 text-xs">
                                <div class="w-2 h-2 rounded-full" :style="{ backgroundColor: cat.color }"></div>
                                <span class="text-slate-400 truncate">{{ cat.name }}: <span class="text-white font-mono">{{ cat.percentage }}%</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Grafico Andamento Saldo -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="text-sm font-bold text-slate-300 mb-4">
                            <i class="fas fa-chart-line text-cyan-400 mr-2"></i>Andamento Saldo
                        </h3>
                        <div class="h-64">
                            <canvas ref="chartBalance"></canvas>
                        </div>
                        <div class="flex justify-between mt-4 text-xs text-slate-500">
                            <span>Min: <span class="text-red-400 font-mono">€ {{ formatNumber(chartData.minBalance) }}</span></span>
                            <span>Media: <span class="text-yellow-400 font-mono">€ {{ formatNumber(chartData.avgBalance) }}</span></span>
                            <span>Max: <span class="text-green-400 font-mono">€ {{ formatNumber(chartData.maxBalance) }}</span></span>
                        </div>
                    </div>

                    <!-- Grafico Salute Finanziaria Radar -->
                    <div class="glass-card rounded-2xl p-5">
                        <h3 class="text-sm font-bold text-slate-300 mb-4">
                            <i class="fas fa-heartbeat text-pink-400 mr-2"></i>Radar Salute Finanziaria
                        </h3>
                        <div class="h-64 flex items-center justify-center">
                            <canvas ref="chartHealthRadar"></canvas>
                        </div>
                        <div class="text-center mt-4">
                            <span class="text-2xl font-bold" :style="{ color: healthScore?.grade?.color || '#6366f1' }">
                                {{ healthScore?.totalScore || 0 }}/100
                            </span>
                            <span class="text-xs text-slate-500 ml-2">Punteggio Complessivo</span>
                        </div>
                    </div>

                    <!-- Grafico Trend Mensile -->
                    <div class="glass-card rounded-2xl p-5 lg:col-span-2">
                        <h3 class="text-sm font-bold text-slate-300 mb-4">
                            <i class="fas fa-calendar-alt text-amber-400 mr-2"></i>Trend Mensile (Ultimi 6 Mesi)
                        </h3>
                        <div class="h-72">
                            <canvas ref="chartMonthlyTrend"></canvas>
                        </div>
                        <div class="flex justify-center gap-8 mt-4 text-xs">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-2 rounded bg-gradient-to-r from-emerald-500 to-emerald-400"></div>
                                <span class="text-slate-400">Entrate</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-2 rounded bg-gradient-to-r from-rose-500 to-rose-400"></div>
                                <span class="text-slate-400">Uscite</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-2 rounded bg-gradient-to-r from-indigo-500 to-indigo-400"></div>
                                <span class="text-slate-400">Risparmio</span>
                            </div>
                        </div>
                    </div>

                    <!-- Grafico Obiettivi Progress -->
                    <div v-if="savingsGoals.length > 0" class="glass-card rounded-2xl p-5 lg:col-span-2">
                        <h3 class="text-sm font-bold text-slate-300 mb-4">
                            <i class="fas fa-bullseye text-pink-400 mr-2"></i>Progresso Obiettivi di Risparmio
                        </h3>
                        <div class="h-48">
                            <canvas ref="chartGoalsProgress"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDIT TRANSACTION MODAL -->
            <div v-if="showEditTransModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter" @click.self="showEditTransModal = false">
                <div class="glass-card max-w-sm w-full p-6 rounded-2xl animate-enter">
                    <h3 class="text-lg font-bold text-white mb-4">Modifica Transazione</h3>
                    <form @submit.prevent="saveTransactionEdit" class="space-y-3">
                        <input type="text" v-model="editingTrans.desc" class="glass-input w-full rounded-lg p-3 text-sm" placeholder="Descrizione">
                        <input type="number" v-model="editingTrans.amount" step="0.01" class="glass-input w-full rounded-lg p-3 text-sm font-mono" placeholder="Importo">
                        <select v-model="editingTrans.type" class="glass-input w-full rounded-lg p-3 text-sm">
                            <option value="in">Entrata (+)</option>
                            <option value="out">Uscita (-)</option>
                        </select>
                        <input type="text" v-model="editingTrans.date" class="glass-input w-full rounded-lg p-3 text-sm" placeholder="Data">
                        <div class="flex gap-2 mt-4">
                            <button type="button" @click="showEditTransModal = false" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                            <button type="submit" class="flex-1 py-3 rounded-xl bg-blue-600 text-white text-sm font-bold">SALVA</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- EDIT GOAL MODAL -->
            <div v-if="showEditGoalModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter"
                @click.self="showEditGoalModal = false">
                <div class="glass-card max-w-sm w-full p-6 rounded-2xl animate-enter">
                    <h3 class="text-lg font-bold text-white mb-4">Modifica Obiettivo</h3>
                    <form @submit.prevent="saveGoalEdit" class="space-y-3">
                        <label class="text-xs uppercase font-bold text-slate-500">Nome</label>
                        <input type="text" v-model="editingGoal.name" placeholder="Nome"
                            class="glass-input w-full rounded-lg p-3 text-sm">

                        <label class="text-xs uppercase font-bold text-slate-500">Target (€)</label>
                        <input type="number" v-model="editingGoal.targetAmount" placeholder="Target"
                            class="glass-input w-full rounded-lg p-3 text-sm font-mono">

                        <label class="text-xs uppercase font-bold text-slate-500">Salvato Attualmente (€)</label>
                        <input type="number" v-model="editingGoal.currentAmount" placeholder="Attuale"
                            class="glass-input w-full rounded-lg p-3 text-sm font-mono">

                        <label class="text-xs uppercase font-bold text-slate-500">Data Target</label>
                        <input type="date" v-model="editingGoal.targetDate" class="glass-input w-full rounded-lg p-3 text-sm">

                        <div class="flex gap-2 mt-4">
                            <button type="button" @click="deleteGoal" class="py-3 px-4 rounded-xl bg-red-900/50 text-red-300 text-sm font-bold"><i class="fas fa-trash"></i></button>
                            <button type="button" @click="showEditGoalModal = false"
                                class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-pink-600 text-white text-sm font-bold">SALVA</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- EDIT FUTURE INCOME MODAL -->
            <div v-if="showEditIncomeModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter" @click.self="showEditIncomeModal = false">
                <div class="glass-card max-w-sm w-full p-6 rounded-2xl animate-enter">
                    <h3 class="text-lg font-bold text-white mb-4">{{ editingIncome.isNew ? 'Nuova Entrata' : 'Modifica Entrata' }}</h3>
                    <form @submit.prevent="saveFutureIncome" class="space-y-3">
                        <input type="text" v-model="editingIncome.desc" class="glass-input w-full rounded-lg p-3 text-sm" placeholder="Descrizione">
                        <input type="number" v-model="editingIncome.amount" step="0.01" class="glass-input w-full rounded-lg p-3 text-sm font-mono" placeholder="Importo">
                        <div class="flex items-center gap-2 mt-2">
                             <input type="checkbox" v-model="editingIncome.received" id="incomeReceived" class="w-4 h-4 rounded bg-slate-700 border-slate-600">
                             <label for="incomeReceived" class="text-sm text-slate-300">Già Ricevuto</label>
                        </div>
                        <div class="flex gap-2 mt-4">
                            <button type="button" @click="deleteFutureIncome" v-if="!editingIncome.isNew" class="py-3 px-4 rounded-xl bg-red-900/50 text-red-300 text-sm font-bold"><i class="fas fa-trash"></i></button>
                            <button type="button" @click="showEditIncomeModal = false" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                            <button type="submit" class="flex-1 py-3 rounded-xl bg-green-600 text-white text-sm font-bold">SALVA</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- EDIT LOAN MODAL -->
            <div v-if="showEditLoanModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter" @click.self="showEditLoanModal = false">
                <div class="glass-card max-w-sm w-full p-6 rounded-2xl animate-enter">
                    <h3 class="text-lg font-bold text-white mb-4">Modifica Credito</h3>
                    <form @submit.prevent="saveLoanEdit" class="space-y-3">
                        <label class="text-xs uppercase font-bold text-slate-500">Debitore</label>
                        <input type="text" v-model="editingLoan.debtor" class="glass-input w-full rounded-lg p-3 text-sm" placeholder="Nome Debitore">

                        <label class="text-xs uppercase font-bold text-slate-500">Descrizione</label>
                        <input type="text" v-model="editingLoan.desc" class="glass-input w-full rounded-lg p-3 text-sm" placeholder="Descrizione">

                        <label class="text-xs uppercase font-bold text-slate-500">Importo Originale</label>
                        <input type="number" v-model="editingLoan.originalAmount" step="0.01" class="glass-input w-full rounded-lg p-3 text-sm font-mono">

                        <label class="text-xs uppercase font-bold text-slate-500">Già Rimborsato</label>
                        <input type="number" v-model="editingLoan.repaidAmount" step="0.01" class="glass-input w-full rounded-lg p-3 text-sm font-mono">

                        <div class="flex gap-2 mt-4">
                            <button type="button" @click="deleteLoan" class="py-3 px-4 rounded-xl bg-red-900/50 text-red-300 text-sm font-bold"><i class="fas fa-trash"></i></button>
                            <button type="button" @click="showEditLoanModal = false" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                            <button type="submit" class="flex-1 py-3 rounded-xl bg-yellow-600 text-white text-sm font-bold">SALVA</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- ADD GOAL MODAL -->
            <div v-if="showAddGoalModal"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter"
                @click.self="showAddGoalModal = false">
                <div class="glass-card max-w-sm w-full p-6 rounded-2xl animate-enter">
                    <h3 class="text-lg font-bold text-white mb-4">Nuovo Obiettivo</h3>
                    <form @submit.prevent="saveNewGoal" class="space-y-3">
                        <input type="text" v-model="newGoalData.name" placeholder="Nome obiettivo (es. Vacanza)"
                            class="glass-input w-full rounded-lg p-3 text-sm">
                        <input type="number" v-model="newGoalData.amount" placeholder="Importo Target (€)"
                            class="glass-input w-full rounded-lg p-3 text-sm">
                        <input type="date" v-model="newGoalData.date" class="glass-input w-full rounded-lg p-3 text-sm">

                        <div class="flex gap-2 mt-4">
                            <button type="button" @click="showAddGoalModal = false"
                                class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                            <button type="submit"
                                class="flex-1 py-3 rounded-xl bg-pink-600 text-white text-sm font-bold">CREA</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- HEALTH INFO MODAL -->
            <div v-if="showHealthInfo"
                class="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-enter"
                @click.self="showHealthInfo = false">
                <div class="glass-card max-w-2xl w-full rounded-2xl overflow-hidden flex flex-col max-h-[90vh]">
                    <div class="p-6 border-b border-slate-700/50 flex justify-between items-center bg-slate-800/50">
                        <h3 class="text-xl font-bold text-white"><i
                                class="fas fa-heartbeat text-indigo-400 mr-2"></i>Guida alla Salute Finanziaria</h3>
                        <button @click="showHealthInfo = false" class="text-slate-400 hover:text-white transition"><i
                                class="fas fa-times text-xl"></i></button>
                    </div>

                    <div class="p-6 overflow-y-auto space-y-6">
                        <p class="text-slate-300 text-sm leading-relaxed">
                            Il tuo punteggio di salute finanziaria (0-100) è calcolato su 5 pilastri fondamentali. Ecco
                            cosa significano e perché sono importanti per te:
                        </p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/30">
                                <div class="flex items-center gap-3 mb-2">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center text-green-400">
                                        <i class="fas fa-piggy-bank"></i></div>
                                    <h4 class="font-bold text-white">Saving Rate</h4>
                                </div>
                                <p class="text-xs text-slate-400 leading-relaxed">
                                    È la percentuale delle tue entrate che riesci a non spendere. <br>
                                    <span class="text-indigo-300">Utilità:</span> Più è alto, più velocemente costruisci
                                    ricchezza e sicurezza per il futuro.
                                </p>
                            </div>

                            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/30">
                                <div class="flex items-center gap-3 mb-2">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400">
                                        <i class="fas fa-balance-scale-right"></i></div>
                                    <h4 class="font-bold text-white">Debt Ratio</h4>
                                </div>
                                <p class="text-xs text-slate-400 leading-relaxed">
                                    Quanto i tuoi debiti pesano sulle tue entrate mensili. <br>
                                    <span class="text-indigo-300">Utilità:</span> Tenerlo basso ti evita di lavorare
                                    solo per ripagare prestiti e riduce lo stress finanziario.
                                </p>
                            </div>

                            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/30">
                                <div class="flex items-center gap-3 mb-2">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                                        <i class="fas fa-clipboard-check"></i></div>
                                    <h4 class="font-bold text-white">Budget Adherence</h4>
                                </div>
                                <p class="text-xs text-slate-400 leading-relaxed">
                                    Quanto spesso riesci a rispettare i limiti di spesa che ti sei dato. <br>
                                    <span class="text-indigo-300">Utilità:</span> Indica la tua autodisciplina e
                                    capacità di controllo sulle uscite.
                                </p>
                            </div>

                            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/30">
                                <div class="flex items-center gap-3 mb-2">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center text-yellow-400">
                                        <i class="fas fa-shield-alt"></i></div>
                                    <h4 class="font-bold text-white">Emergency Fund</h4>
                                </div>
                                <p class="text-xs text-slate-400 leading-relaxed">
                                    Quanti mesi potresti vivere senza entrate usando solo i tuoi risparmi attuali. <br>
                                    <span class="text-indigo-300">Utilità:</span> È il tuo "cuscinetto" contro
                                    imprevisti (perdita lavoro, spese mediche, guasti).
                                </p>
                            </div>

                            <div class="bg-slate-800/40 p-4 rounded-xl border border-slate-700/30 md:col-span-2">
                                <div class="flex items-center gap-3 mb-2">
                                    <div
                                        class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400">
                                        <i class="fas fa-chart-line"></i></div>
                                    <h4 class="font-bold text-white">Consistency</h4>
                                </div>
                                <p class="text-xs text-slate-400 leading-relaxed">
                                    Quanto sono regolari e prevedibili le tue entrate nel tempo. <br>
                                    <span class="text-indigo-300">Utilità:</span> Entrate stabili rendono molto più
                                    facile pianificare il futuro e fare investimenti a lungo termine.
                                </p>
                            </div>
                        </div>

                        <div class="mt-6 pt-4 border-t border-slate-700/50 text-center">
                            <button @click="showHealthInfo = false"
                                class="bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 px-8 rounded-xl transition w-full md:w-auto">
                                Ho Capito, Grazie!
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL MODIFICA SALDO -->
            <div v-if="showBalanceEditModal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-4 overflow-y-auto" @click="showBalanceEditModal = false">
                <div class="min-h-screen flex items-center justify-center">
                    <div class="glass-card max-w-md w-full rounded-2xl p-6" @click.stop>
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-white"><i class="fas fa-wallet text-indigo-400 mr-2"></i>Modifica Saldo</h3>
                            <button @click="showBalanceEditModal = false" class="text-slate-400 hover:text-white text-xl">&times;</button>
                        </div>
                        <div class="mb-4 p-3 bg-slate-800/50 rounded-lg">
                            <div class="text-xs text-slate-400">Saldo attuale</div>
                            <div class="text-2xl font-bold text-white">€ {{ formatNumber(currentBalance) }}</div>
                        </div>
                        <form @submit.prevent="saveBalanceEdit" class="space-y-3">
                            <div class="grid grid-cols-2 gap-2 p-1 bg-slate-900/50 rounded-xl">
                                <button type="button" @click="newBalanceEdit.type = 'add'"
                                    class="py-2 rounded-lg text-sm font-bold transition-all"
                                    :class="newBalanceEdit.type === 'add' ? 'bg-green-600 text-white' : 'text-slate-400'">+ Aggiungi</button>
                                <button type="button" @click="newBalanceEdit.type = 'subtract'"
                                    class="py-2 rounded-lg text-sm font-bold transition-all"
                                    :class="newBalanceEdit.type === 'subtract' ? 'bg-red-600 text-white' : 'text-slate-400'">- Sottrai</button>
                            </div>
                            <input type="number" v-model.number="newBalanceEdit.amount" placeholder="Importo (€)" step="0.01"
                                class="glass-input w-full rounded-lg p-3 text-sm">
                            <input type="text" v-model="newBalanceEdit.description" placeholder="Descrizione (es. Stipendio, Regalo, ecc.)"
                                class="glass-input w-full rounded-lg p-3 text-sm">
                            <div class="flex gap-2 mt-4">
                                <button type="button" @click="showBalanceEditModal = false"
                                    class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                                <button type="submit" :disabled="!newBalanceEdit.amount || !newBalanceEdit.description"
                                    class="flex-1 py-3 rounded-xl bg-indigo-600 text-white text-sm font-bold disabled:opacity-50">APPLICA</button>
                            </div>
                        </form>
                        <!-- Storico modifiche saldo -->
                        <div v-if="balanceHistory.length > 0" class="mt-6 pt-4 border-t border-slate-700">
                            <h4 class="text-sm font-bold text-slate-400 mb-3">Storico Modifiche</h4>
                            <div class="max-h-40 overflow-y-auto space-y-2">
                                <div v-for="(entry, idx) in balanceHistory.slice().reverse()" :key="idx"
                                    class="flex justify-between items-center p-2 bg-slate-800/40 rounded-lg text-xs">
                                    <div>
                                        <div class="text-slate-200">{{ entry.description }}</div>
                                        <div class="text-slate-500">{{ entry.date }}</div>
                                    </div>
                                    <span :class="entry.type === 'add' ? 'text-green-400' : 'text-red-400'" class="font-mono font-bold">
                                        {{ entry.type === 'add' ? '+' : '-' }}€ {{ formatNumber(entry.amount) }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MODAL NUOVA SPESA RATEIZZATA -->
            <template v-if="showAddInstallmentModal">
                <div class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-4 overflow-y-auto" @click="showAddInstallmentModal = false">
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="glass-card max-w-md w-full rounded-2xl p-6" @click.stop>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white"><i class="fas fa-calendar-alt text-orange-400 mr-2"></i>Nuova Spesa Rateizzata</h3>
                                <button type="button" @click="showAddInstallmentModal = false" class="text-slate-400 hover:text-white text-xl">&times;</button>
                            </div>
                            <form @submit.prevent="saveNewInstallment" class="space-y-3">
                                <input type="text" v-model="newInstallment.name" placeholder="Nome (es. iPhone, Divano)" class="glass-input w-full rounded-lg p-3 text-sm">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-slate-500">Importo Totale (€)</label>
                                        <input type="number" v-model.number="newInstallment.totalAmount" step="0.01" class="glass-input w-full rounded-lg p-3 text-sm" @input="calcRateAmount">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500">Numero Rate</label>
                                        <input type="number" v-model.number="newInstallment.numRates" min="1" class="glass-input w-full rounded-lg p-3 text-sm" @input="calcRateAmount">
                                    </div>
                                </div>
                                <div class="p-3 bg-slate-800/50 rounded-lg text-center">
                                    <div class="text-xs text-slate-400">Importo per rata</div>
                                    <div class="text-xl font-bold text-orange-400">€ {{ formatNumber(newInstallment.rateAmount || 0) }}</div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs text-slate-500">Giorno del mese</label>
                                        <input type="number" v-model.number="newInstallment.dayOfMonth" min="1" max="31" class="glass-input w-full rounded-lg p-3 text-sm">
                                    </div>
                                    <div>
                                        <label class="text-xs text-slate-500">Notifica giorni prima</label>
                                        <input type="number" v-model.number="newInstallment.notifyDaysBefore" min="0" max="7" class="glass-input w-full rounded-lg p-3 text-sm">
                                    </div>
                                </div>
                                <div class="flex gap-2 mt-4">
                                    <button type="button" @click="showAddInstallmentModal = false" class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                                    <button type="submit" :disabled="!newInstallment.name || !newInstallment.totalAmount || !newInstallment.numRates" class="flex-1 py-3 rounded-xl bg-orange-600 text-white text-sm font-bold disabled:opacity-50">CREA</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </template>

            <!-- MODAL MODIFICA SPESA RATEIZZATA -->
            <template v-if="showEditInstallmentModal && editingInstallment">
                <div class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm p-4 overflow-y-auto" @click="showEditInstallmentModal = false">
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="glass-card max-w-md w-full rounded-2xl p-6" @click.stop>
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-bold text-white"><i class="fas fa-edit text-orange-400 mr-2"></i>Modifica Rata</h3>
                                <button type="button" @click="showEditInstallmentModal = false" class="text-slate-400 hover:text-white text-xl">&times;</button>
                            </div>
                            <form @submit.prevent="saveInstallmentEdit" class="space-y-3">
                                <input type="text" v-model="editingInstallment.name" placeholder="Nome"
                                class="glass-input w-full rounded-lg p-3 text-sm">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-slate-500">Importo per rata (€)</label>
                                    <input type="number" v-model.number="editingInstallment.rateAmount" step="0.01"
                                        class="glass-input w-full rounded-lg p-3 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Rate pagate</label>
                                    <input type="number" v-model.number="editingInstallment.paidRates" min="0" :max="editingInstallment.numRates"
                                        class="glass-input w-full rounded-lg p-3 text-sm">
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-xs text-slate-500">Giorno del mese</label>
                                    <input type="number" v-model.number="editingInstallment.dayOfMonth" min="1" max="31"
                                        class="glass-input w-full rounded-lg p-3 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs text-slate-500">Notifica giorni prima</label>
                                    <input type="number" v-model.number="editingInstallment.notifyDaysBefore" min="0" max="7"
                                        class="glass-input w-full rounded-lg p-3 text-sm">
                                </div>
                            </div>
                            <div class="flex gap-2 mt-4">
                                <button type="button" @click="deleteInstallment(editingInstallment.id)"
                                    class="py-3 px-4 rounded-xl bg-red-600/20 text-red-400 text-sm font-bold">ELIMINA</button>
                                <button type="button" @click="showEditInstallmentModal = false"
                                    class="flex-1 py-3 rounded-xl bg-slate-700 text-slate-300 text-sm font-bold">ANNULLA</button>
                                <button type="submit"
                                    class="flex-1 py-3 rounded-xl bg-orange-600 text-white text-sm font-bold">SALVA</button>
                            </div>
                            </form>
                        </div>
                    </div>
                </div>
            </template>

        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    needsSetup: false,
                    authenticated: false,
                    loading: false,
                    isSyncing: false,
                    error: false,
                    errorMsg: '',
                    inputPin: '',
                    setup: { binId: '', apiKey: '' },
                    lastSavedTime: '...',
                    currentBalance: 110,
                    manualTransactions: [],
                    activeLoans: [],
                    futureIncomes: [
                        { desc: "Restituzione residuo papà", amount: 800, received: false },
                        { desc: "Due rate EduNet19 (10%+10%)", amount: 560, received: false },
                        { desc: "Conguaglio EduNet19 (30%)", amount: 840, received: false },
                        { desc: "Residuo Progetto Franco", amount: 200, received: false },
                        { desc: "Borsa di Studio Unimi", amount: 1936, received: false }
                    ],
                    newTrans: { desc: '', amount: null, type: 'out', category: 'other' },
                    newLoan: { debtor: '', desc: '', amount: null },
                    repayInput: {},
                    syncManager: null,
                    categories: [],
                    showInstallPrompt: false,
                    installEvent: null,

                    // NEW DATA PROPERTIES
                    healthScore: null,
                    insights: [],
                    savingsGoals: [],
                    showAddGoalModal: false,
                    newGoalData: { name: '', amount: null, date: '' },
                    showHealthInfo: false,
                    
                    // PAPA LOAN DATA (modificabile manualmente)
                    papaLoanData: { totalOriginal: 0, totalRepaid: 0, useManual: false },

                    // EDIT MODALS
                    showEditTransModal: false,
                    editingTrans: null,
                    showEditIncomeModal: false,
                    editingIncome: null,
                    showEditLoanModal: false,
                    editingLoan: null,
                    showEditGoalModal: false,
                    editingGoal: null,

                    // STORICO MODIFICHE SALDO
                    balanceHistory: [],
                    showBalanceEditModal: false,
                    newBalanceEdit: { amount: null, description: '', type: 'add' },

                    // SPESE RATEIZZATE
                    installments: [],
                    showAddInstallmentModal: false,
                    showEditInstallmentModal: false,
                    editingInstallment: null,
                    newInstallment: { 
                        name: '', 
                        totalAmount: null, 
                        numRates: null, 
                        rateAmount: null,
                        startDate: '',
                        dayOfMonth: 1,
                        paidRates: 0,
                        notifyDaysBefore: 1
                    },

                    // GRAFICI
                    chartPeriod: '30d',
                    chartData: {
                        totalIncome: 0,
                        totalExpense: 0,
                        topCategories: [],
                        minBalance: 0,
                        maxBalance: 0,
                        avgBalance: 0
                    },
                    charts: {}
                };
            },
            watch: {
                chartPeriod() {
                    this.updateCharts();
                }
            },
            computed: {
                dadLoans() {
                    return this.activeLoans.filter(l => l.debtor && (l.debtor.toLowerCase().includes('papà') || l.debtor.toLowerCase().includes('papa') || l.debtor.toLowerCase().includes('padre')));
                },
                totalLoanOriginal() {
                    // Se useManual è true, usa i dati manuali
                    if (this.papaLoanData.useManual) {
                        return this.papaLoanData.totalOriginal;
                    }
                    const dadTotal = this.dadLoans.reduce((acc, l) => acc + l.originalAmount, 0);
                    return dadTotal || this.papaLoanData.totalOriginal;
                },
                totalRepaid() {
                    if (this.papaLoanData.useManual) {
                        return this.papaLoanData.totalRepaid;
                    }
                    const dadRepaid = this.dadLoans.reduce((acc, l) => acc + l.repaidAmount, 0);
                    return dadRepaid || this.papaLoanData.totalRepaid;
                },
                remainingLoan() { return Math.max(0, this.totalLoanOriginal - this.totalRepaid); },
                loanProgress() {
                    if (this.totalLoanOriginal === 0) return 0;
                    return Math.min(100, Math.round((this.totalRepaid / this.totalLoanOriginal) * 100));
                },
                forecastBalance() {
                    let pendingIncome = this.futureIncomes.filter(i => !i.received).reduce((acc, i) => acc + i.amount, 0);
                    const recurringForecast = typeof recurringManager !== 'undefined' ? recurringManager.calculateFutureImpact(30) : { netImpact: 0 };
                    return this.currentBalance + pendingIncome + recurringForecast.netImpact - 526;
                },
                totalActiveCredits() {
                    return this.activeLoans.reduce((acc, l) => acc + (l.originalAmount - l.repaidAmount), 0);
                },
                // Statistiche mensili
                monthlyExpenses() {
                    const now = new Date();
                    const thisMonth = now.getMonth();
                    const thisYear = now.getFullYear();
                    return this.manualTransactions
                        .filter(t => {
                            if (!t.timestamp) return false;
                            const d = new Date(t.timestamp);
                            return t.type === 'out' && d.getMonth() === thisMonth && d.getFullYear() === thisYear;
                        })
                        .reduce((sum, t) => sum + t.amount, 0);
                },
                monthlyIncome() {
                    const now = new Date();
                    const thisMonth = now.getMonth();
                    const thisYear = now.getFullYear();
                    return this.manualTransactions
                        .filter(t => {
                            if (!t.timestamp) return false;
                            const d = new Date(t.timestamp);
                            return t.type === 'in' && d.getMonth() === thisMonth && d.getFullYear() === thisYear;
                        })
                        .reduce((sum, t) => sum + t.amount, 0);
                },
                monthlyBalance() {
                    return this.monthlyIncome - this.monthlyExpenses;
                }
            },
            async mounted() {
                const cloudConfig = localStorage.getItem('futura_cloud_config');
                if (!cloudConfig) {
                    this.needsSetup = true;
                } else {
                    this.setup = JSON.parse(cloudConfig);
                }

                // Load categories
                if (typeof categoryManager !== 'undefined') {
                    this.categories = categoryManager.getAllCategories();
                }

                // Register service worker
                this.registerServiceWorker();

                // PWA install prompt
                this.setupPWAInstall();

                // Request notification permission dopo qualche secondo
                setTimeout(() => {
                    if (typeof notificationManager !== 'undefined' && notificationManager.permission === 'default') {
                        this.requestNotificationPermission();
                    }
                }, 5000);
            },
            methods: {
                async saveSetup() {
                    if (!this.setup.binId || !this.setup.apiKey) {
                        this.error = true;
                        this.errorMsg = "Inserisci tutti i campi";
                        return;
                    }
                    this.setup.binId = this.setup.binId.trim();
                    this.setup.apiKey = this.setup.apiKey.trim();
                    this.loading = true;
                    this.error = false;
                    try {
                        await this.loadDataFromCloud();
                        localStorage.setItem('futura_cloud_config', JSON.stringify(this.setup));
                        this.needsSetup = false;
                        this.authenticated = true;

                        // Initialize SyncManager
                        if (typeof SyncManager !== 'undefined') {
                            this.syncManager = new SyncManager(this.setup.binId, this.setup.apiKey);
                            this.syncManager.startAutoSync(5);
                        }
                    } catch (e) {
                        this.error = true;
                        this.errorMsg = "CONNESSIONE FALLITA: " + e.message;
                    } finally {
                        this.loading = false;
                    }
                },
                resetConfig() {
                    localStorage.removeItem('futura_cloud_config');
                    location.reload();
                },
                async checkPin() {
                    if (this.inputPin === '0000') {
                        this.loading = true;
                        this.error = false;
                        try {
                            await this.loadDataFromCloud();
                            this.authenticated = true;
                        } catch (e) {
                            this.error = true;
                            this.errorMsg = "ERRORE CLOUD: " + e.message;
                        } finally {
                            this.loading = false;
                        }
                    } else {
                        this.error = true;
                        this.errorMsg = "PIN Errato";
                        this.inputPin = '';
                    }
                },
                async loadDataFromCloud() {
                    const binId = this.setup.binId.trim();
                    const apiKey = this.setup.apiKey.trim();

                    const response = await fetch(`https://api.jsonbin.io/v3/b/${binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': apiKey,
                            'X-Bin-Meta': 'false'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 404) throw new Error("BIN ID NON TROVATO (Controlla l'ID)");
                        if (response.status === 403 || response.status === 401) throw new Error("CHIAVE ERRATA (Controlla Master Key)");
                        throw new Error(`Errore Server (${response.status})`);
                    }

                    const data = await response.json();

                    if (data.currentBalance !== undefined) this.currentBalance = data.currentBalance;
                    if (data.futureIncomes) this.futureIncomes = data.futureIncomes;
                    if (data.manualTransactions) this.manualTransactions = data.manualTransactions;
                    if (data.activeLoans) this.activeLoans = data.activeLoans;
                    if (data.lastSavedTime) this.lastSavedTime = data.lastSavedTime;

                    // Load Savings Goals if present
                    if (data.savingsGoals) {
                        this.savingsGoals = data.savingsGoals;
                        if (typeof savingsGoalManager !== 'undefined') {
                            savingsGoalManager.goals = this.savingsGoals;
                        }
                    }

                    // Load Papa Loan Data if present
                    if (data.papaLoanData) {
                        this.papaLoanData = data.papaLoanData;
                    }

                    // Load Balance History if present
                    if (data.balanceHistory && Array.isArray(data.balanceHistory)) {
                        this.balanceHistory = data.balanceHistory;
                    }

                    // Load Installments if present
                    if (data.installments && Array.isArray(data.installments)) {
                        this.installments = data.installments;
                        // Controlla notifiche rate in scadenza
                        this.$nextTick(() => this.scheduleInstallmentNotifications());
                    }

                    this.refreshAnalysis();
                },
                async syncData(manual = false) {
                    this.isSyncing = true;
                    const now = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                    this.lastSavedTime = now;
                    const payload = {
                        currentBalance: this.currentBalance,
                        futureIncomes: this.futureIncomes,
                        manualTransactions: this.manualTransactions,
                        activeLoans: this.activeLoans,
                        savingsGoals: this.savingsGoals,
                        papaLoanData: this.papaLoanData,
                        balanceHistory: this.balanceHistory,
                        installments: this.installments,
                        lastSavedTime: now
                    };
                    try {
                        const binId = this.setup.binId.trim();
                        const apiKey = this.setup.apiKey.trim();

                        await fetch(`https://api.jsonbin.io/v3/b/${binId}`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json', 'X-Master-Key': apiKey },
                            body: JSON.stringify(payload)
                        });
                        if (manual) {
                            const icon = this.$refs.syncIcon;
                            icon.className = "fas fa-check text-green-400";
                            setTimeout(() => icon.className = "fas fa-cloud-upload-alt", 1500);
                        }
                    } catch (e) {
                        alert("Errore salvataggio: " + e.message);
                    } finally {
                        this.isSyncing = false;
                    }
                },
                formatNumber(val) {
                    return val.toLocaleString('it-IT', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                },
                toggleIncome(index) {
                    const item = this.futureIncomes[index];
                    item.received = !item.received;
                    if (item.received) this.currentBalance += item.amount;
                    else this.currentBalance -= item.amount;
                    this.syncData();
                    this.refreshAnalysis();
                },
                addTransaction() {
                    if (!this.newTrans.desc || !this.newTrans.amount) return;
                    const amount = parseFloat(this.newTrans.amount);
                    if (this.newTrans.type === 'in') this.currentBalance += amount;
                    else this.currentBalance -= amount;

                    let category = this.newTrans.category;
                    if (typeof categoryManager !== 'undefined' && (!category || category === 'other')) {
                        category = categoryManager.autoCategorizeDinámico(this.newTrans.desc);
                    }

                    this.manualTransactions.unshift({
                        id: typeof generateId !== 'undefined' ? generateId() : Date.now(),
                        desc: this.newTrans.desc,
                        amount: amount,
                        type: this.newTrans.type,
                        category: category,
                        date: new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }),
                        timestamp: new Date().toISOString()
                    });

                    this.newTrans.desc = '';
                    this.newTrans.amount = null;
                    this.newTrans.category = 'other';
                    this.syncData();
                    this.refreshAnalysis();

                    // Check budget alerts
                    if (typeof budgetManager !== 'undefined') {
                        const alerts = budgetManager.checkBudgetAlerts(this.manualTransactions);
                        alerts.forEach(alert => {
                            if (typeof notificationManager !== 'undefined') {
                                if (alert.type === 'exceeded') {
                                    notificationManager.notifyBudgetExceeded(alert.budget.category, Math.abs(alert.budget.amount - alert.budget.spent));
                                } else if (alert.type === 'warning') {
                                    notificationManager.notifyBudgetWarning(alert.budget.category, alert.percentage);
                                }
                            }
                        });
                    }
                },
                editTransaction(index) {
                    const t = this.manualTransactions[index];
                    this.editingTrans = { ...t, index: index }; // Clone and store index
                    this.showEditTransModal = true;
                },
                saveTransactionEdit() {
                    const idx = this.editingTrans.index;
                    const oldTrans = this.manualTransactions[idx];
                    const newTrans = this.editingTrans;

                    // Revert old balance effect
                    if (oldTrans.type === 'in') this.currentBalance -= oldTrans.amount;
                    else this.currentBalance += oldTrans.amount;

                    // Apply new balance effect
                    if (newTrans.type === 'in') this.currentBalance += parseFloat(newTrans.amount);
                    else this.currentBalance -= parseFloat(newTrans.amount);

                    // Update array
                    this.manualTransactions[idx] = {
                        ...oldTrans,
                        desc: newTrans.desc,
                        amount: parseFloat(newTrans.amount),
                        type: newTrans.type,
                        date: newTrans.date
                    };

                    this.showEditTransModal = false;
                    this.editingTrans = null;
                    this.syncData();
                    this.refreshAnalysis();
                },
                removeTransaction(index) {
                    if(!confirm('Sei sicuro di voler eliminare questa transazione?')) return;
                    const t = this.manualTransactions[index];
                    if (t.type === 'in') this.currentBalance -= t.amount;
                    else this.currentBalance += t.amount;
                    this.manualTransactions.splice(index, 1);
                    this.syncData();
                    this.refreshAnalysis();
                },

                // FUTURE INCOME METHODS
                addFutureIncome() {
                    this.editingIncome = { desc: '', amount: null, received: false, isNew: true };
                    this.showEditIncomeModal = true;
                },
                editFutureIncome(index) {
                    const inc = this.futureIncomes[index];
                    this.editingIncome = { ...inc, index: index, isNew: false };
                    this.showEditIncomeModal = true;
                },
                saveFutureIncome() {
                    const amount = parseFloat(this.editingIncome.amount);
                    if (!this.editingIncome.desc || isNaN(amount)) return;

                    if (this.editingIncome.isNew) {
                        this.futureIncomes.push({
                            desc: this.editingIncome.desc,
                            amount: amount,
                            received: this.editingIncome.received
                        });
                        if (this.editingIncome.received) this.currentBalance += amount;
                    } else {
                        const idx = this.editingIncome.index;
                        const oldInc = this.futureIncomes[idx];

                        // Handle balance change if received status or amount changed
                        if (oldInc.received) this.currentBalance -= oldInc.amount;
                        if (this.editingIncome.received) this.currentBalance += amount;

                        this.futureIncomes[idx] = {
                            desc: this.editingIncome.desc,
                            amount: amount,
                            received: this.editingIncome.received
                        };
                    }
                    this.showEditIncomeModal = false;
                    this.syncData();
                    this.refreshAnalysis();
                },
                deleteFutureIncome() {
                    if(!confirm('Eliminare questa voce?')) return;
                    const idx = this.editingIncome.index;
                    const inc = this.futureIncomes[idx];
                    if (inc.received) this.currentBalance -= inc.amount;
                    this.futureIncomes.splice(idx, 1);
                    this.showEditIncomeModal = false;
                    this.syncData();
                    this.refreshAnalysis();
                },

                // LOAN EDIT METHODS
                editLoan(loan) {
                    // Clone deep enough
                    this.editingLoan = JSON.parse(JSON.stringify(loan));
                    this.showEditLoanModal = true;
                },
                saveLoanEdit() {
                    const idx = this.activeLoans.findIndex(l => l.id === this.editingLoan.id);
                    if (idx === -1) return;

                    const oldLoan = this.activeLoans[idx];
                    const newLoan = this.editingLoan;

                    const diff = parseFloat(newLoan.originalAmount) - oldLoan.originalAmount;
                    if (diff !== 0) {
                        this.currentBalance -= diff;
                    }

                    // Update
                    this.activeLoans[idx] = {
                        ...oldLoan,
                        debtor: newLoan.debtor,
                        desc: newLoan.desc,
                        originalAmount: parseFloat(newLoan.originalAmount),
                        repaidAmount: parseFloat(newLoan.repaidAmount)
                    };

                    this.showEditLoanModal = false;
                    this.syncData();
                    this.refreshAnalysis();
                },
                deleteLoan() {
                    if(!confirm('Eliminare questo credito? Il saldo non verrà modificato automaticamente (eccetto rimborsi futuri).')) return;
                    const idx = this.activeLoans.findIndex(l => l.id === this.editingLoan.id);
                    if (idx !== -1) {
                        this.activeLoans.splice(idx, 1);
                    }
                    this.showEditLoanModal = false;
                    this.syncData();
                    this.refreshAnalysis();
                },

                addLoan() {
                    if (!this.newLoan.debtor || !this.newLoan.desc || !this.newLoan.amount) return;
                    const amount = parseFloat(this.newLoan.amount);
                    this.currentBalance -= amount;

                    this.activeLoans.unshift({
                        id: Date.now(),
                        debtor: this.newLoan.debtor,
                        desc: this.newLoan.desc,
                        originalAmount: amount,
                        repaidAmount: 0,
                        date: new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }),
                        history: []
                    });

                    this.newLoan.debtor = '';
                    this.newLoan.desc = '';
                    this.newLoan.amount = null;
                    this.syncData();
                    this.refreshAnalysis();
                },
                repayLoan(loanId) {
                    const amount = parseFloat(this.repayInput[loanId]);
                    if (!amount || amount <= 0) return;

                    const loan = this.activeLoans.find(l => l.id === loanId);
                    if (!loan) return;

                    this.currentBalance += amount;
                    loan.repaidAmount += amount;

                    if (!loan.history) loan.history = [];
                    loan.history.push({
                        date: new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short' }),
                        amount: amount
                    });

                    this.repayInput[loanId] = null;
                    this.syncData();
                    this.refreshAnalysis();
                },

                // NEW METHODS FOR ANALYSIS
                refreshAnalysis() {
                    // Update Health Score
                    if (typeof healthScoreCalculator !== 'undefined') {
                        this.healthScore = healthScoreCalculator.calculateScore(
                            this.manualTransactions,
                            this.currentBalance,
                            [], // budgets (can be added later)
                            this.activeLoans
                        );
                    }

                    // Update Insights
                    if (typeof insightsEngine !== 'undefined') {
                        this.insights = insightsEngine.generateInsights(
                            this.manualTransactions,
                            this.currentBalance,
                            [], // budgets
                            this.activeLoans
                        );
                    }

                    // Update Charts
                    this.updateCharts();
                },

                // CHART METHODS
                updateCharts() {
                    this.calculateChartData();
                    this.$nextTick(() => {
                        this.renderIncomeExpenseChart();
                        this.renderCategoriesChart();
                        this.renderBalanceChart();
                        this.renderHealthRadarChart();
                        this.renderMonthlyTrendChart();
                        this.renderGoalsProgressChart();
                    });
                },

                calculateChartData() {
                    const now = new Date();
                    let filteredTransactions = [...this.manualTransactions];
                    
                    // Filter by period
                    if (this.chartPeriod === '7d') {
                        const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                        filteredTransactions = filteredTransactions.filter(t => new Date(t.timestamp || t.date) >= weekAgo);
                    } else if (this.chartPeriod === '30d') {
                        const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                        filteredTransactions = filteredTransactions.filter(t => new Date(t.timestamp || t.date) >= monthAgo);
                    }

                    // Calculate totals
                    this.chartData.totalIncome = filteredTransactions
                        .filter(t => t.type === 'in')
                        .reduce((sum, t) => sum + t.amount, 0);
                    
                    this.chartData.totalExpense = filteredTransactions
                        .filter(t => t.type === 'out')
                        .reduce((sum, t) => sum + t.amount, 0);

                    // Calculate categories
                    const categoryTotals = {};
                    filteredTransactions.filter(t => t.type === 'out').forEach(t => {
                        const cat = t.category || 'Altro';
                        categoryTotals[cat] = (categoryTotals[cat] || 0) + t.amount;
                    });

                    const categoryColors = {
                        'food': '#22c55e', 'transport': '#3b82f6', 'entertainment': '#a855f7',
                        'shopping': '#f59e0b', 'bills': '#ef4444', 'health': '#ec4899',
                        'education': '#06b6d4', 'other': '#6b7280', 'Altro': '#6b7280'
                    };

                    const total = Object.values(categoryTotals).reduce((a, b) => a + b, 0) || 1;
                    this.chartData.topCategories = Object.entries(categoryTotals)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 6)
                        .map(([name, amount]) => ({
                            name: this.getCategoryLabel(name),
                            amount,
                            percentage: Math.round((amount / total) * 100),
                            color: categoryColors[name] || '#6b7280'
                        }));

                    // Calculate balance stats
                    const balances = [this.currentBalance];
                    let runningBalance = this.currentBalance;
                    [...filteredTransactions].reverse().forEach(t => {
                        runningBalance += t.type === 'out' ? t.amount : -t.amount;
                        balances.push(runningBalance);
                    });
                    
                    this.chartData.minBalance = Math.min(...balances);
                    this.chartData.maxBalance = Math.max(...balances);
                    this.chartData.avgBalance = balances.reduce((a, b) => a + b, 0) / balances.length;
                },

                getCategoryLabel(cat) {
                    const labels = {
                        'food': 'Cibo', 'transport': 'Trasporti', 'entertainment': 'Svago',
                        'shopping': 'Shopping', 'bills': 'Bollette', 'health': 'Salute',
                        'education': 'Istruzione', 'other': 'Altro', 'Altro': 'Altro'
                    };
                    return labels[cat] || cat;
                },

                renderIncomeExpenseChart() {
                    const ctx = this.$refs.chartIncomeExpense;
                    if (!ctx) return;

                    if (this.charts.incomeExpense) this.charts.incomeExpense.destroy();

                    this.charts.incomeExpense = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Entrate', 'Uscite'],
                            datasets: [{
                                data: [this.chartData.totalIncome, this.chartData.totalExpense],
                                backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(244, 63, 94, 0.8)'],
                                borderColor: ['#10b981', '#f43f5e'],
                                borderWidth: 2,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { 
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#94a3b8', callback: v => '€' + v }
                                },
                                x: { 
                                    grid: { display: false },
                                    ticks: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                },

                renderCategoriesChart() {
                    const ctx = this.$refs.chartCategories;
                    if (!ctx || this.chartData.topCategories.length === 0) return;

                    if (this.charts.categories) this.charts.categories.destroy();

                    this.charts.categories = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: this.chartData.topCategories.map(c => c.name),
                            datasets: [{
                                data: this.chartData.topCategories.map(c => c.amount),
                                backgroundColor: this.chartData.topCategories.map(c => c.color),
                                borderWidth: 0,
                                hoverOffset: 10
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '65%',
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: ctx => `${ctx.label}: €${ctx.raw.toFixed(2)} (${this.chartData.topCategories[ctx.dataIndex].percentage}%)`
                                    }
                                }
                            }
                        }
                    });
                },

                renderBalanceChart() {
                    const ctx = this.$refs.chartBalance;
                    if (!ctx) return;

                    if (this.charts.balance) this.charts.balance.destroy();

                    // Generate balance history
                    const labels = [];
                    const data = [];
                    let balance = this.currentBalance;
                    
                    const transactions = [...this.manualTransactions].slice(0, 15).reverse();
                    transactions.forEach((t, i) => {
                        labels.push(t.date || `T${i+1}`);
                        balance += t.type === 'out' ? t.amount : -t.amount;
                        data.push(balance);
                    });
                    labels.push('Oggi');
                    data.push(this.currentBalance);

                    this.charts.balance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels,
                            datasets: [{
                                data,
                                borderColor: '#06b6d4',
                                backgroundColor: 'rgba(6, 182, 212, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 3,
                                pointBackgroundColor: '#06b6d4'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#94a3b8', callback: v => '€' + v }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#94a3b8', maxRotation: 45 }
                                }
                            }
                        }
                    });
                },

                renderHealthRadarChart() {
                    const ctx = this.$refs.chartHealthRadar;
                    if (!ctx || !this.healthScore) return;

                    if (this.charts.healthRadar) this.charts.healthRadar.destroy();

                    const metrics = this.healthScore.metrics || {};
                    const labels = ['Saving Rate', 'Debt Ratio', 'Budget', 'Emergency', 'Consistency'];
                    const maxScores = [30, 25, 20, 15, 10];
                    const data = [
                        metrics.savingRate?.score || 0,
                        metrics.debtRatio?.score || 0,
                        metrics.budgetAdherence?.score || 0,
                        metrics.emergencyFund?.score || 0,
                        metrics.consistency?.score || 0
                    ].map((score, i) => (score / maxScores[i]) * 100);

                    this.charts.healthRadar = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels,
                            datasets: [{
                                data,
                                backgroundColor: 'rgba(99, 102, 241, 0.3)',
                                borderColor: '#6366f1',
                                borderWidth: 2,
                                pointBackgroundColor: '#6366f1',
                                pointRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                r: {
                                    beginAtZero: true,
                                    max: 100,
                                    grid: { color: 'rgba(255,255,255,0.1)' },
                                    angleLines: { color: 'rgba(255,255,255,0.1)' },
                                    pointLabels: { color: '#94a3b8', font: { size: 10 } },
                                    ticks: { display: false }
                                }
                            },
                            plugins: { legend: { display: false } }
                        }
                    });
                },

                renderMonthlyTrendChart() {
                    const ctx = this.$refs.chartMonthlyTrend;
                    if (!ctx) return;

                    if (this.charts.monthlyTrend) this.charts.monthlyTrend.destroy();

                    // Generate last 6 months data
                    const months = [];
                    const incomeData = [];
                    const expenseData = [];
                    const savingsData = [];

                    for (let i = 5; i >= 0; i--) {
                        const date = new Date();
                        date.setMonth(date.getMonth() - i);
                        const monthName = date.toLocaleDateString('it-IT', { month: 'short' });
                        months.push(monthName.charAt(0).toUpperCase() + monthName.slice(1));

                        const monthTransactions = this.manualTransactions.filter(t => {
                            const tDate = new Date(t.timestamp || t.date);
                            return tDate.getMonth() === date.getMonth() && tDate.getFullYear() === date.getFullYear();
                        });

                        const income = monthTransactions.filter(t => t.type === 'in').reduce((s, t) => s + t.amount, 0);
                        const expense = monthTransactions.filter(t => t.type === 'out').reduce((s, t) => s + t.amount, 0);
                        
                        incomeData.push(income);
                        expenseData.push(expense);
                        savingsData.push(income - expense);
                    }

                    this.charts.monthlyTrend = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: months,
                            datasets: [
                                {
                                    label: 'Entrate',
                                    data: incomeData,
                                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                    borderRadius: 4
                                },
                                {
                                    label: 'Uscite',
                                    data: expenseData,
                                    backgroundColor: 'rgba(244, 63, 94, 0.8)',
                                    borderRadius: 4
                                },
                                {
                                    label: 'Risparmio',
                                    data: savingsData,
                                    type: 'line',
                                    borderColor: '#6366f1',
                                    backgroundColor: 'transparent',
                                    tension: 0.4,
                                    pointRadius: 4,
                                    pointBackgroundColor: '#6366f1'
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#94a3b8', callback: v => '€' + v }
                                },
                                x: {
                                    grid: { display: false },
                                    ticks: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                },

                renderGoalsProgressChart() {
                    const ctx = this.$refs.chartGoalsProgress;
                    if (!ctx || this.savingsGoals.length === 0) return;

                    if (this.charts.goalsProgress) this.charts.goalsProgress.destroy();

                    const labels = this.savingsGoals.map(g => g.name);
                    const currentData = this.savingsGoals.map(g => g.currentAmount);
                    const remainingData = this.savingsGoals.map(g => Math.max(0, g.targetAmount - g.currentAmount));

                    this.charts.goalsProgress = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels,
                            datasets: [
                                {
                                    label: 'Raggiunto',
                                    data: currentData,
                                    backgroundColor: 'rgba(236, 72, 153, 0.8)',
                                    borderRadius: 4
                                },
                                {
                                    label: 'Rimanente',
                                    data: remainingData,
                                    backgroundColor: 'rgba(100, 116, 139, 0.4)',
                                    borderRadius: 4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            plugins: { legend: { display: false } },
                            scales: {
                                x: {
                                    stacked: true,
                                    grid: { color: 'rgba(255,255,255,0.05)' },
                                    ticks: { color: '#94a3b8', callback: v => '€' + v }
                                },
                                y: {
                                    stacked: true,
                                    grid: { display: false },
                                    ticks: { color: '#94a3b8' }
                                }
                            }
                        }
                    });
                },

                getMetricColor(status) {
                    if (status === 'excellent') return 'bg-green-500';
                    if (status === 'good') return 'bg-teal-400';
                    if (status === 'fair') return 'bg-yellow-400';
                    if (status === 'poor') return 'bg-orange-400';
                    return 'bg-red-500';
                },

                saveNewGoal() {
                    if (!this.newGoalData.name || !this.newGoalData.amount) return;

                    if (typeof savingsGoalManager !== 'undefined') {
                        const goal = savingsGoalManager.createGoal(
                            this.newGoalData.name,
                            this.newGoalData.amount,
                            this.newGoalData.date
                        );
                        this.savingsGoals = savingsGoalManager.getAllGoals();
                        this.syncData();
                    }

                    this.showAddGoalModal = false;
                    this.newGoalData = { name: '', amount: null, date: '' };
                },

                addGoalContribution(goal) {
                    const amount = prompt(`Quanto vuoi versare per ${goal.name}?`);
                    if (amount && !isNaN(amount)) {
                        if (typeof savingsGoalManager !== 'undefined') {
                            savingsGoalManager.addContribution(goal.id, parseFloat(amount));
                            this.currentBalance -= parseFloat(amount); // Deduct from balance
                            this.syncData();
                            this.refreshAnalysis();
                        }
                    }
                },

                editGoal(goal) {
                    this.editingGoal = JSON.parse(JSON.stringify(goal));
                    this.showEditGoalModal = true;
                },
                saveGoalEdit() {
                    if (!this.editingGoal.name || this.editingGoal.targetAmount === null) return;

                    const idx = this.savingsGoals.findIndex(g => g.id === this.editingGoal.id);
                    if (idx === -1) return;

                    const oldGoal = this.savingsGoals[idx];
                    const newGoal = this.editingGoal;

                    // Adjust balance based on difference in current saved amount
                    const diff = parseFloat(newGoal.currentAmount) - oldGoal.currentAmount;
                    if (diff !== 0) {
                        this.currentBalance -= diff;
                    }

                    this.savingsGoals[idx] = {
                        ...oldGoal,
                        name: newGoal.name,
                        targetAmount: parseFloat(newGoal.targetAmount),
                        currentAmount: parseFloat(newGoal.currentAmount),
                        targetDate: newGoal.targetDate
                    };

                    this.showEditGoalModal = false;
                    this.syncData();
                    this.refreshAnalysis();
                },
                deleteGoal() {
                    if(!confirm('Eliminare questo obiettivo? Il saldo risparmiato verrà restituito alla disponibilità.')) return;
                    const idx = this.savingsGoals.findIndex(g => g.id === this.editingGoal.id);
                    if (idx !== -1) {
                        const amount = this.savingsGoals[idx].currentAmount;
                        this.currentBalance += amount; // Refund to balance
                        this.savingsGoals.splice(idx, 1);
                    }
                    this.showEditGoalModal = false;
                    this.syncData();
                    this.refreshAnalysis();
                },

                async registerServiceWorker() {
                    if ('serviceWorker' in navigator) {
                        try {
                            const registration = await navigator.serviceWorker.register('sw.js');
                            console.log('[PWA] Service Worker registered:', registration.scope);

                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('[PWA] New version available, reload to update');
                                    }
                                });
                            });
                        } catch (error) {
                            console.error('[PWA] Service Worker registration failed:', error);
                        }
                    }
                },
                setupPWAInstall() {
                    window.addEventListener('beforeinstallprompt', (e) => {
                        e.preventDefault();
                        this.installEvent = e;
                        this.showInstallPrompt = true;
                        console.log('[PWA] Install prompt ready');
                    });

                    window.addEventListener('appinstalled', () => {
                        this.showInstallPrompt = false;
                        this.installEvent = null;
                        console.log('[PWA] App installed');
                    });
                },
                async installPWA() {
                    if (!this.installEvent) return;

                    this.installEvent.prompt();
                    const result = await this.installEvent.userChoice;

                    if (result.outcome === 'accepted') {
                        console.log('[PWA] User accepted install');
                    }

                    this.showInstallPrompt = false;
                    this.installEvent = null;
                },
                async requestNotificationPermission() {
                    if (typeof notificationManager !== 'undefined') {
                        const granted = await notificationManager.requestPermission();
                        if (granted) {
                            console.log('[Not ifications] Permission granted');
                        }
                    }
                },
                logout() {
                    this.authenticated = false;
                    this.inputPin = '';
                },

                // METODI MODIFICA SALDO CON STORICO
                saveBalanceEdit() {
                    if (!this.newBalanceEdit.amount || !this.newBalanceEdit.description) return;
                    
                    const amount = parseFloat(this.newBalanceEdit.amount);
                    const entry = {
                        id: Date.now(),
                        amount: amount,
                        description: this.newBalanceEdit.description,
                        type: this.newBalanceEdit.type,
                        date: new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' }),
                        balanceBefore: this.currentBalance
                    };
                    
                    if (this.newBalanceEdit.type === 'add') {
                        this.currentBalance += amount;
                    } else {
                        this.currentBalance -= amount;
                    }
                    entry.balanceAfter = this.currentBalance;
                    
                    this.balanceHistory.push(entry);
                    this.showBalanceEditModal = false;
                    this.newBalanceEdit = { amount: null, description: '', type: 'add' };
                    this.syncData();
                    this.refreshAnalysis();
                },

                // METODI SPESE RATEIZZATE
                calcRateAmount() {
                    if (this.newInstallment.totalAmount && this.newInstallment.numRates) {
                        this.newInstallment.rateAmount = Math.round((this.newInstallment.totalAmount / this.newInstallment.numRates) * 100) / 100;
                    }
                },

                saveNewInstallment() {
                    if (!this.newInstallment.name || !this.newInstallment.totalAmount || !this.newInstallment.numRates) return;
                    
                    const inst = {
                        id: Date.now(),
                        name: this.newInstallment.name,
                        totalAmount: this.newInstallment.totalAmount,
                        numRates: this.newInstallment.numRates,
                        rateAmount: this.newInstallment.rateAmount || (this.newInstallment.totalAmount / this.newInstallment.numRates),
                        dayOfMonth: this.newInstallment.dayOfMonth || 1,
                        paidRates: 0,
                        notifyDaysBefore: this.newInstallment.notifyDaysBefore || 1,
                        createdAt: new Date().toISOString()
                    };
                    
                    this.installments.push(inst);
                    this.showAddInstallmentModal = false;
                    this.newInstallment = { name: '', totalAmount: null, numRates: null, rateAmount: null, startDate: '', dayOfMonth: 1, paidRates: 0, notifyDaysBefore: 1 };
                    this.syncData();
                    this.scheduleInstallmentNotifications();
                },

                editInstallment(inst) {
                    this.editingInstallment = { ...inst };
                    this.showEditInstallmentModal = true;
                },

                saveInstallmentEdit() {
                    const idx = this.installments.findIndex(i => i.id === this.editingInstallment.id);
                    if (idx !== -1) {
                        this.installments[idx] = { ...this.editingInstallment };
                    }
                    this.showEditInstallmentModal = false;
                    this.editingInstallment = null;
                    this.syncData();
                    this.scheduleInstallmentNotifications();
                },

                deleteInstallment(id) {
                    if (confirm('Sei sicuro di voler eliminare questa spesa rateizzata?')) {
                        this.installments = this.installments.filter(i => i.id !== id);
                        this.showEditInstallmentModal = false;
                        this.editingInstallment = null;
                        this.syncData();
                    }
                },

                payInstallmentRate(inst) {
                    if (inst.paidRates < inst.numRates) {
                        inst.paidRates++;
                        this.currentBalance -= inst.rateAmount;
                        
                        // Aggiungi allo storico modifiche saldo
                        this.balanceHistory.push({
                            id: Date.now(),
                            amount: inst.rateAmount,
                            description: `Rata ${inst.paidRates}/${inst.numRates} - ${inst.name}`,
                            type: 'subtract',
                            date: new Date().toLocaleDateString('it-IT', { day: 'numeric', month: 'short', year: 'numeric' }),
                            balanceBefore: this.currentBalance + inst.rateAmount,
                            balanceAfter: this.currentBalance
                        });
                        
                        this.syncData();
                        this.refreshAnalysis();
                    }
                },

                scheduleInstallmentNotifications() {
                    // Controlla se ci sono rate in scadenza
                    const today = new Date();
                    const currentDay = today.getDate();
                    
                    this.installments.forEach(inst => {
                        if (inst.paidRates >= inst.numRates) return; // Già completato
                        
                        const daysUntilDue = inst.dayOfMonth - currentDay;
                        
                        if (daysUntilDue >= 0 && daysUntilDue <= inst.notifyDaysBefore) {
                            if (typeof notificationManager !== 'undefined') {
                                notificationManager.notify(
                                    `Rata in scadenza: ${inst.name}`,
                                    `La rata di €${inst.rateAmount} scade ${daysUntilDue === 0 ? 'oggi' : `tra ${daysUntilDue} giorni`}`,
                                    'warning'
                                );
                            }
                        }
                    });
                },

                // METODO LEGACY (mantenuto per compatibilità)
                editBalance() {
                    this.showBalanceEditModal = true;
                },

                editPapaLoan() {
                    const choice = prompt('Cosa vuoi modificare?\n1 = Importo Totale Prestato\n2 = Importo Già Restituito\n3 = Entrambi\n4 = Usa calcolo automatico dai prestiti', '1');
                    if (!choice) return;
                    
                    if (choice === '4') {
                        this.papaLoanData.useManual = false;
                        this.syncData();
                        this.refreshAnalysis();
                        return;
                    }
                    
                    this.papaLoanData.useManual = true;
                    
                    if (choice === '1' || choice === '3') {
                        const newTotal = prompt('Importo Totale Prestato a Papà (€):', this.totalLoanOriginal);
                        if (newTotal !== null && !isNaN(parseFloat(newTotal))) {
                            this.papaLoanData.totalOriginal = parseFloat(newTotal);
                        }
                    }
                    if (choice === '2' || choice === '3') {
                        const newRepaid = prompt('Importo Già Restituito da Papà (€):', this.totalRepaid);
                        if (newRepaid !== null && !isNaN(parseFloat(newRepaid))) {
                            this.papaLoanData.totalRepaid = parseFloat(newRepaid);
                        }
                    }
                    this.syncData();
                    this.refreshAnalysis();
                },

                // NUOVE FUNZIONALITÀ UTILI
                
                // Esporta dati in JSON
                exportData() {
                    const data = {
                        currentBalance: this.currentBalance,
                        manualTransactions: this.manualTransactions,
                        futureIncomes: this.futureIncomes,
                        activeLoans: this.activeLoans,
                        savingsGoals: this.savingsGoals,
                        papaLoanData: this.papaLoanData,
                        exportDate: new Date().toISOString()
                    };
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `futura-sync-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                },

                // Reset rapido di tutti i dati (con conferma)
                resetAllData() {
                    if (confirm('⚠️ ATTENZIONE: Vuoi davvero cancellare TUTTI i dati?\n\nQuesta azione è irreversibile!')) {
                        if (confirm('Sei ASSOLUTAMENTE sicuro? Tutti i dati andranno persi!')) {
                            this.currentBalance = 0;
                            this.manualTransactions = [];
                            this.futureIncomes = [];
                            this.activeLoans = [];
                            this.savingsGoals = [];
                            this.papaLoanData = { totalOriginal: 0, totalRepaid: 0, useManual: false };
                            this.syncData();
                            this.refreshAnalysis();
                            alert('Tutti i dati sono stati cancellati.');
                        }
                    }
                }
            }
        }).mount('#app');
    </script>
</body>

</html>